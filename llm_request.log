ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
<<<<<<< HEAD
Triá»ƒn khai má»™t web server Ä‘Æ¡n giáº£n. Táº¡o má»™t key pair má»›i. Táº¡o má»™t security group má»›i trong VPC máº·c Ä‘á»‹nh, cho phÃ©p truy cáº­p HTTP (cá»•ng 80) vÃ  SSH (cá»•ng 22) tá»« má»i nÆ¡i. Sau Ä‘Ã³, táº¡o má»™t EC2 instance t3.micro sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t, key pair vÃ  security group vá»«a táº¡o. Äáº·t tÃªn instance lÃ  'my-crai-web-server'.
=======
create a new ec2
>>>>>>> 3d3a2cbccf1753872a42818ae52d778a78a26cf8

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT AVAILABLE STATE ON AWS ACCOUNT)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-02727ad6a5611dd78
  Name: my-simple-web-server
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0bde73fd629657a59, InstanceId:i-02727ad6a5611dd78, InstanceType:t3.micro, KeyName:my-web-server-key, LaunchTime:2025-11-06 08:48:50+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'sa-east-1a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-06 08:50:34 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:9c01ce44-3d84-48be-9866-05f2045ac71f, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-06 08:48:50+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:my-simple-web-server}
- ID: vpc-0054bcca2ef516ccc
  Name: vpc-0054bcca2ef516ccc
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:172.31.0.0/16, DhcpOptionsId:dopt-0c7273ae4ab6b762e, State:available, VpcId:vpc-0054bcca2ef516ccc, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-06fc4675b8c7ab62e', 'CidrBlock': '172.31.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:True}
  Tags: {}
- ID: sg-0047e87d8873212da
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0047e87d8873212da', 'UserId': '782859940219'}]}, {'FromPort': 443, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 443, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0047e87d8873212da, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0054bcca2ef516ccc}
  Tags: {}
- ID: sg-0c988da22eaf384ff
  Name: my-test-alb-sg-20251106083254
  Type: aws_security_group
  Status: available
  Properties: {Description:Security group for my-test-alb, allowing HTTP and HTTPS traffic, GroupName:my-test-alb-sg-20251106083254, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 443, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 443, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0c988da22eaf384ff, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0054bcca2ef516ccc}
  Tags: {}
- ID: sg-0ffb09ae78847f064
  Name: web-sg
  Type: aws_security_group
  Status: available
  Properties: {Description:Security group for web server allowing HTTP and SSH, GroupName:web-sg, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0ffb09ae78847f064, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0054bcca2ef516ccc}
  Tags: {}
- ID: my-db-subnet-group
  Name: my-db-subnet-group
  Type: aws_rds_db_subnet_group
  Status: Complete
  Properties: {DBSubnetGroupName:my-db-subnet-group, DBSubnetGroupDescription:DB Subnet Group for my-mysql-db, VpcId:vpc-0054bcca2ef516ccc, SubnetGroupStatus:Complete, Subnets:[{'SubnetIdentifier': 'subnet-007a2aca7a6c9a0c7', 'SubnetAvailabilityZone': {'Name': 'sa-east-1b'}, 'SubnetOutpost': {}, 'SubnetStatus': 'Active'}, {'SubnetIdentifier': 'subnet-0a6ebc6838cd6abbe', 'SubnetAvailabilityZone': {'Name': 'sa-east-1a'}, 'SubnetOutpost': {}, 'SubnetStatus': 'Active'}, {'SubnetIdentifier': 'subnet-0bdc3a8cb4f37a664', 'SubnetAvailabilityZone': {'Name': 'sa-east-1c'}, 'SubnetOutpost': {}, 'SubnetStatus': 'Active'}], DBSubnetGroupArn:arn:aws:rds:sa-east-1:782859940219:subgrp:my-db-subnet-group, SupportedNetworkTypes:['IPV4']}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0bde73fd629657a59
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'List subnets in default VPC' (ID: step-list-subnets) ---
Executing tool 'list-subnets' with resolved params: {'vpc_id': 'vpc-0054bcca2ef516ccc'}
Executing tool 'list-subnets' with params: {'vpc_id': 'vpc-0054bcca2ef516ccc'}
Listing subnets for VPC ID: vpc-0054bcca2ef516ccc
Listing subnets for VPC ID: vpc-0054bcca2ef516ccc
Found 3 subnets in VPC vpc-0054bcca2ef516ccc.
Tool 'list-subnets' executed successfully.
Step 'List subnets in default VPC' completed. Result stored in context for ID 'step-list-subnets'.
--- Preparing to execute step: 'Create new EC2 key pair' (ID: step-create-key-pair) ---
Executing tool 'create-key-pair' with resolved params: {'key_name': 'my-crai-web-server-key-20251106085327'}
Executing tool 'create-key-pair' with params: {'key_name': 'my-crai-web-server-key-20251106085327'}
Executing CreateKeyPairTool with key_name: my-crai-web-server-key-20251106085327
Creating key pair: my-crai-web-server-key-20251106085327
Tool 'create-key-pair' executed successfully.
Step 'Create new EC2 key pair' completed. Result stored in context for ID 'step-create-key-pair'.
--- Preparing to execute step: 'Create new security group for web server' (ID: step-create-security-group) ---
Executing tool 'create-security-group' with resolved params: {'group_name': 'my-crai-web-sg-20251106085330', 'description': 'Security group for my-crai-web-server, allowing HTTP and SSH', 'vpc_id': 'vpc-0054bcca2ef516ccc'}
Executing tool 'create-security-group' with params: {'group_name': 'my-crai-web-sg-20251106085330', 'description': 'Security group for my-crai-web-server, allowing HTTP and SSH', 'vpc_id': 'vpc-0054bcca2ef516ccc'}
Creating security group 'my-crai-web-sg-20251106085330' in VPC 'vpc-0054bcca2ef516ccc'...
Security group 'my-crai-web-sg-20251106085330' created with ID: sg-0cb4e043cd373f322
Security group 'my-crai-web-sg-20251106085330' created with ID: sg-0cb4e043cd373f322
Tool 'create-security-group' executed successfully.
Step 'Create new security group for web server' completed. Result stored in context for ID 'step-create-security-group'.
--- Preparing to execute step: 'Add HTTP ingress rule to security group' (ID: step-add-http-ingress-rule) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-0cb4e043cd373f322', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-0cb4e043cd373f322', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-0cb4e043cd373f322' for tcp:80-80 from 0.0.0.0/0...
Ingress rule added to security group 'sg-0cb4e043cd373f322'.
Ingress rule added to security group 'sg-0cb4e043cd373f322'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add HTTP ingress rule to security group' completed. Result stored in context for ID 'step-add-http-ingress-rule'.
--- Preparing to execute step: 'Add SSH ingress rule to security group' (ID: step-add-ssh-ingress-rule) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-0cb4e043cd373f322', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-0cb4e043cd373f322', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-0cb4e043cd373f322' for tcp:22-22 from 0.0.0.0/0...
Ingress rule added to security group 'sg-0cb4e043cd373f322'.
Ingress rule added to security group 'sg-0cb4e043cd373f322'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add SSH ingress rule to security group' completed. Result stored in context for ID 'step-add-ssh-ingress-rule'.
--- Preparing to execute step: 'Create EC2 instance for web server' (ID: step-create-ec2-instance) ---
Executing tool 'create-ec2-instance' with resolved params: {'image_id': 'ami-0bde73fd629657a59', 'instance_type': 't3.micro', 'key_name': 'my-crai-web-server-key-20251106085327', 'subnet_id': 'subnet-007a2aca7a6c9a0c7', 'security_group_ids': ['sg-0cb4e043cd373f322'], 'tags': [{'Key': 'Name', 'Value': 'my-crai-web-server'}]}
Executing tool 'create-ec2-instance' with params: {'image_id': 'ami-0bde73fd629657a59', 'instance_type': 't3.micro', 'key_name': 'my-crai-web-server-key-20251106085327', 'subnet_id': 'subnet-007a2aca7a6c9a0c7', 'security_group_ids': ['sg-0cb4e043cd373f322'], 'tags': [{'Key': 'Name', 'Value': 'my-crai-web-server'}]}
Executing tool: create-ec2-instance
Creating EC2 instance with image 'ami-0bde73fd629657a59' and type 't3.micro'
Tool 'create-ec2-instance' executed successfully.
<<<<<<< HEAD
Step 'Create EC2 instance for web server' completed. Result stored in context for ID 'step-create-ec2-instance'.
Added/updated resource 'i-01c7e8cf3de6f1685' to the state.
Saved new resource 'i-01c7e8cf3de6f1685' of type 'aws_ec2_instance' to state.
=======
Step 'Create EC2 Instance' completed. Result stored in context for ID 'step-create-ec2-instance'.
Added/updated resource 'i-08574472bc1955da8' to the state.
Saved new resource 'i-08574472bc1955da8' of type 'aws_ec2_instance' to state.
--- Preparing to execute step: 'Create S3 Bucket for Logs' (ID: step-create-s3-bucket) ---
Could not resolve path 'random_string' in context. Failed at key 'random_string'.
Could not resolve placeholder {random_string}: Could not resolve variable path 'random_string' in context. Debug Info: {'failed_key': 'random_string', 'current_value_type': 'dict', 'current_value_keys': ['step-list-azs', 'step-get-ubuntu-ami', 'step-create-vpc', 'step-create-igw', 'step-attach-igw', 'step-create-public-subnet', 'step-create-key-pair', 'step-create-security-group', 'step-add-ssh-ingress', 'step-add-http-ingress', 'step-create-ec2-instance'], 'attempted_pascal_case': 'RandomString'}
Executing tool 'create-s3-bucket' with resolved params: {'bucket_name': 'web-logs-20251103191646-{random_string}'}
Executing tool 'create-s3-bucket' with params: {'bucket_name': 'web-logs-20251103191646-{random_string}'}
Executing CreateS3BucketTool for bucket: web-logs-20251103191646-{random_string}
Creating S3 bucket: web-logs-20251103191646-{random_string} in region: eu-west-2
Error creating S3 bucket 'web-logs-20251103191646-{random_string}': Parameter validation failed:
Invalid bucket name "web-logs-20251103191646-{random_string}": Bucket name must match the regex "^[a-zA-Z0-9.\-_]{1,255}$" or be an ARN matching the regex "^arn:(aws).*:(s3|s3-object-lambda):[a-z\-0-9]*:[0-9]{12}:accesspoint[/:][a-zA-Z0-9\-.]{1,63}$|^arn:(aws).*:s3-outposts:[a-z\-0-9]+:[0-9]{12}:outpost[/:][a-zA-Z0-9\-]{1,63}[/:]accesspoint[/:][a-zA-Z0-9\-]{1,63}$"
Failed to create S3 bucket: Parameter validation failed:
Invalid bucket name "web-logs-20251103191646-{random_string}": Bucket name must match the regex "^[a-zA-Z0-9.\-_]{1,255}$" or be an ARN matching the regex "^arn:(aws).*:(s3|s3-object-lambda):[a-z\-0-9]*:[0-9]{12}:accesspoint[/:][a-zA-Z0-9\-.]{1,63}$|^arn:(aws).*:s3-outposts:[a-z\-0-9]+:[0-9]{12}:outpost[/:][a-zA-Z0-9\-]{1,63}[/:]accesspoint[/:][a-zA-Z0-9\-]{1,63}$"
Tool 'create-s3-bucket' execution failed with error: Parameter validation failed:
Invalid bucket name "web-logs-20251103191646-{random_string}": Bucket name must match the regex "^[a-zA-Z0-9.\-_]{1,255}$" or be an ARN matching the regex "^arn:(aws).*:(s3|s3-object-lambda):[a-z\-0-9]*:[0-9]{12}:accesspoint[/:][a-zA-Z0-9\-.]{1,63}$|^arn:(aws).*:s3-outposts:[a-z\-0-9]+:[0-9]{12}:outpost[/:][a-zA-Z0-9\-]{1,63}[/:]accesspoint[/:][a-zA-Z0-9\-]{1,63}$"
An unexpected error occurred in the WebSocket handler: 'random_string'
WebSocket connection closed.
Initializing StateAwareAgent singleton...
Initializing StateManager singleton...
Initializing ToolFactory singleton...
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
ToolFactory initialized with 27 tools.
Initializing DiscoveryScanner singleton...
LLM Provider configured: gemini
LLM Model configured: gemini-2.5-flash
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
StateAwareAgent initialized.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 12 resources.
Set discovered state with 12 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-08574472bc1955da8
  Name: web-server-20251103191645
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-08574472bc1955da8, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:16:45+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-66.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.66, ProductCodes:[], PublicDnsName:, PublicIpAddress:3.8.160.191, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-0ce720e0ed16f300d, VpcId:vpc-0ce6c066ac77bb3af, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 16, 46, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-046d7f5199479de2e'}}], ClientToken:1bff7f03-1222-4fbb-ba81-a80ba3294855, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '3.8.160.191'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 16, 45, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-023f19371f4341c46', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg', 'GroupId': 'sg-00d27dd9ba9dfa933'}], 'Ipv6Addresses': [], 'MacAddress': '06:a4:77:56:2f:c5', 'NetworkInterfaceId': 'eni-0552b61863bb999de', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.66', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '3.8.160.191'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.66'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-0ce720e0ed16f300d', 'VpcId': 'vpc-0ce6c066ac77bb3af', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg', 'GroupId': 'sg-00d27dd9ba9dfa933'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:16:45+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103191645}
- ID: vpc-0037e273d9a25b018
  Name: web-environment-vpc-20251103184222
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0037e273d9a25b018, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0458adae56bab214b', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {Name:web-environment-vpc-20251103184222}
- ID: vpc-0db9637c9355c491a
  Name: vpc-0db9637c9355c491a
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0db9637c9355c491a, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c39f7307c3843e7f', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0a542f771823f955d
  Name: vpc-0a542f771823f955d
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0a542f771823f955d, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-080177ad80d396768', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0a491d6f0d2edf8c2
  Name: vpc-0a491d6f0d2edf8c2
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0a491d6f0d2edf8c2, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-053d4fd0c08f9a2de', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0ce6c066ac77bb3af
  Name: vpc-0ce6c066ac77bb3af
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0ce6c066ac77bb3af, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0b85506747c327845', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: sg-00d27dd9ba9dfa933
  Name: web-sg
  Type: aws_security_group
  Status: available
  Properties: {Description:Security group for web server (SSH and HTTP access), GroupName:web-sg, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-00d27dd9ba9dfa933, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}
- ID: sg-04a3ac097b372b980
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-04a3ac097b372b980', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-04a3ac097b372b980, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0db9637c9355c491a}
  Tags: {}
- ID: sg-0819d71d35457443e
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0819d71d35457443e', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0819d71d35457443e, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0037e273d9a25b018}
  Tags: {}
- ID: sg-0cfa29c63ca7e40b2
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0cfa29c63ca7e40b2', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0cfa29c63ca7e40b2, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a542f771823f955d}
  Tags: {}
- ID: sg-0d70b380cca5440ad
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0d70b380cca5440ad', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0d70b380cca5440ad, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}
- ID: sg-099b9b313aff962f2
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-099b9b313aff962f2', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-099b9b313aff962f2, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a491d6f0d2edf8c2}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'List Availability Zones' (ID: step-list-azs) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'List Availability Zones' completed. Result stored in context for ID 'step-list-azs'.
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'Create new VPC' (ID: step-create-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.0.0.0/16', 'name': 'web-environment-vpc-20251103191921'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.0.0.0/16', 'name': 'web-environment-vpc-20251103191921'}
Executing CreateVpcTool with CIDR: 10.0.0.0/16
Creating VPC with CIDR block: 10.0.0.0/16
Error creating VPC: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
Failed to create VPC: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
Tool 'create-vpc' execution failed with error: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
Execution failed at step 'Create new VPC': Tool 'create-vpc' execution failed: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
An unexpected error occurred in the WebSocket handler: Tool 'create-vpc' execution failed: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
WebSocket connection closed.
Initializing StateAwareAgent singleton...
Initializing StateManager singleton...
Initializing ToolFactory singleton...
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
ToolFactory initialized with 27 tools.
Initializing DiscoveryScanner singleton...
LLM Provider configured: gemini
LLM Model configured: gemini-2.5-flash
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
StateAwareAgent initialized.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 4 resources.
Set discovered state with 4 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-08574472bc1955da8
  Name: web-server-20251103191645
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-08574472bc1955da8, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:16:45+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-66.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.66, ProductCodes:[], PublicDnsName:, PublicIpAddress:3.8.160.191, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-0ce720e0ed16f300d, VpcId:vpc-0ce6c066ac77bb3af, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 16, 46, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-046d7f5199479de2e'}}], ClientToken:1bff7f03-1222-4fbb-ba81-a80ba3294855, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '3.8.160.191'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 16, 45, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-023f19371f4341c46', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg', 'GroupId': 'sg-00d27dd9ba9dfa933'}], 'Ipv6Addresses': [], 'MacAddress': '06:a4:77:56:2f:c5', 'NetworkInterfaceId': 'eni-0552b61863bb999de', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.66', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '3.8.160.191'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.66'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-0ce720e0ed16f300d', 'VpcId': 'vpc-0ce6c066ac77bb3af', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg', 'GroupId': 'sg-00d27dd9ba9dfa933'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:16:45+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103191645}
- ID: vpc-0ce6c066ac77bb3af
  Name: vpc-0ce6c066ac77bb3af
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0ce6c066ac77bb3af, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0b85506747c327845', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: sg-00d27dd9ba9dfa933
  Name: web-sg
  Type: aws_security_group
  Status: available
  Properties: {Description:Security group for web server (SSH and HTTP access), GroupName:web-sg, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-00d27dd9ba9dfa933, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}
- ID: sg-0d70b380cca5440ad
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0d70b380cca5440ad', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0d70b380cca5440ad, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'List existing Key Pairs' (ID: step-list-key-pairs) ---
Executing tool 'list-key-pairs' with resolved params: {}
Executing tool 'list-key-pairs' with params: {}
Executing ListKeyPairsTool
Listing all key pairs
Tool 'list-key-pairs' executed successfully.
Step 'List existing Key Pairs' completed. Result stored in context for ID 'step-list-key-pairs'.
--- Preparing to execute step: 'List Availability Zones' (ID: step-list-azs) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'List Availability Zones' completed. Result stored in context for ID 'step-list-azs'.
--- Preparing to execute step: 'Create new VPC' (ID: step-create-new-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.1.0.0/16', 'name': 'new-web-vpc-20251103192231'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.1.0.0/16', 'name': 'new-web-vpc-20251103192231'}
Executing CreateVpcTool with CIDR: 10.1.0.0/16
Creating VPC with CIDR block: 10.1.0.0/16
VPC created: vpc-0993e8042919f98a7
Tool 'create-vpc' executed successfully.
Step 'Create new VPC' completed. Result stored in context for ID 'step-create-new-vpc'.
--- Preparing to execute step: 'Create Internet Gateway' (ID: step-create-igw) ---
Executing tool 'create-internet-gateway' with resolved params: {'name': 'new-web-igw-20251103192232'}
Executing tool 'create-internet-gateway' with params: {'name': 'new-web-igw-20251103192232'}
Executing tool: create-internet-gateway
Creating Internet Gateway.
Internet Gateway created: igw-0d55e8ea3d96ec1df
Tool 'create-internet-gateway' executed successfully.
Step 'Create Internet Gateway' completed. Result stored in context for ID 'step-create-igw'.
--- Preparing to execute step: 'Attach Internet Gateway to VPC' (ID: step-attach-igw) ---
Executing tool 'attach-internet-gateway' with resolved params: {'vpc_id': 'vpc-0993e8042919f98a7', 'internet_gateway_id': 'igw-0d55e8ea3d96ec1df'}
Executing tool 'attach-internet-gateway' with params: {'vpc_id': 'vpc-0993e8042919f98a7', 'internet_gateway_id': 'igw-0d55e8ea3d96ec1df'}
Executing tool: attach-internet-gateway
Attaching Internet Gateway 'igw-0d55e8ea3d96ec1df' to VPC 'vpc-0993e8042919f98a7'.
Internet Gateway 'igw-0d55e8ea3d96ec1df' successfully attached to VPC 'vpc-0993e8042919f98a7'.
Tool 'attach-internet-gateway' executed successfully.
Step 'Attach Internet Gateway to VPC' completed. Result stored in context for ID 'step-attach-igw'.
--- Preparing to execute step: 'Create Public Subnet' (ID: step-create-public-subnet) ---
Executing tool 'create-public-subnet' with resolved params: {'vpc_id': 'vpc-0993e8042919f98a7', 'cidr_block': '10.1.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'new-web-public-subnet-20251103192233'}
Executing tool 'create-public-subnet' with params: {'vpc_id': 'vpc-0993e8042919f98a7', 'cidr_block': '10.1.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'new-web-public-subnet-20251103192233'}
Executing tool: create-public-subnet
Creating subnet with CIDR block '10.1.1.0/24' in VPC 'vpc-0993e8042919f98a7' (AZ: eu-west-2a).
Subnet created: subnet-06f0c1b6201fb0e53
Modifying subnet 'subnet-06f0c1b6201fb0e53' to set map_public_ip_on_launch to True.
Subnet 'subnet-06f0c1b6201fb0e53' attribute modified successfully.
Tool 'create-public-subnet' executed successfully.
Step 'Create Public Subnet' completed. Result stored in context for ID 'step-create-public-subnet'.
--- Preparing to execute step: 'Create web-sg Security Group' (ID: step-create-web-sg) ---
Executing tool 'create-security-group' with resolved params: {'group_name': 'web-sg-20251103192234', 'description': 'Allow SSH and HTTP access for web server in new VPC', 'vpc_id': 'vpc-0993e8042919f98a7'}
Executing tool 'create-security-group' with params: {'group_name': 'web-sg-20251103192234', 'description': 'Allow SSH and HTTP access for web server in new VPC', 'vpc_id': 'vpc-0993e8042919f98a7'}
Creating security group 'web-sg-20251103192234' in VPC 'vpc-0993e8042919f98a7'...
Security group 'web-sg-20251103192234' created with ID: sg-0b3b6c9a0c009a733
Security group 'web-sg-20251103192234' created with ID: sg-0b3b6c9a0c009a733
Tool 'create-security-group' executed successfully.
Step 'Create web-sg Security Group' completed. Result stored in context for ID 'step-create-web-sg'.
--- Preparing to execute step: 'Add SSH Ingress Rule to web-sg' (ID: step-add-ssh-ingress) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-0b3b6c9a0c009a733', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-0b3b6c9a0c009a733', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-0b3b6c9a0c009a733' for tcp:22-22 from 0.0.0.0/0...
Ingress rule added to security group 'sg-0b3b6c9a0c009a733'.
Ingress rule added to security group 'sg-0b3b6c9a0c009a733'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add SSH Ingress Rule to web-sg' completed. Result stored in context for ID 'step-add-ssh-ingress'.
--- Preparing to execute step: 'Add HTTP Ingress Rule to web-sg' (ID: step-add-http-ingress) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-0b3b6c9a0c009a733', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-0b3b6c9a0c009a733', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-0b3b6c9a0c009a733' for tcp:80-80 from 0.0.0.0/0...
Ingress rule added to security group 'sg-0b3b6c9a0c009a733'.
Ingress rule added to security group 'sg-0b3b6c9a0c009a733'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add HTTP Ingress Rule to web-sg' completed. Result stored in context for ID 'step-add-http-ingress'.
--- Preparing to execute step: 'Create EC2 Instance' (ID: step-create-ec2-instance) ---
Executing tool 'create-ec2-instance' with resolved params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-01', 'subnet_id': 'subnet-06f0c1b6201fb0e53', 'security_group_ids': ['sg-0b3b6c9a0c009a733'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103192236'}]}
Executing tool 'create-ec2-instance' with params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-01', 'subnet_id': 'subnet-06f0c1b6201fb0e53', 'security_group_ids': ['sg-0b3b6c9a0c009a733'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103192236'}]}
Executing tool: create-ec2-instance
Creating EC2 instance with image 'ami-0850ab57897dcaa32' and type 't3.micro'
Tool 'create-ec2-instance' executed successfully.
Step 'Create EC2 Instance' completed. Result stored in context for ID 'step-create-ec2-instance'.
Added/updated resource 'i-00988ca268341bd1c' to the state.
Saved new resource 'i-00988ca268341bd1c' of type 'aws_ec2_instance' to state.
--- Preparing to execute step: 'Create S3 Bucket for Logs' (ID: step-create-s3-bucket) ---
Could not resolve path 'random_string' in context. Failed at key 'random_string'.
Could not resolve placeholder {random_string}: Could not resolve variable path 'random_string' in context. Debug Info: {'failed_key': 'random_string', 'current_value_type': 'dict', 'current_value_keys': ['step-get-ubuntu-ami', 'step-list-key-pairs', 'step-list-azs', 'step-create-new-vpc', 'step-create-igw', 'step-attach-igw', 'step-create-public-subnet', 'step-create-web-sg', 'step-add-ssh-ingress', 'step-add-http-ingress', 'step-create-ec2-instance'], 'attempted_pascal_case': 'RandomString'}
Executing tool 'create-s3-bucket' with resolved params: {'bucket_name': 'web-logs-20251103192238-{random_string}'}
Executing tool 'create-s3-bucket' with params: {'bucket_name': 'web-logs-20251103192238-{random_string}'}
Executing CreateS3BucketTool for bucket: web-logs-20251103192238-{random_string}
Creating S3 bucket: web-logs-20251103192238-{random_string} in region: eu-west-2
Error creating S3 bucket 'web-logs-20251103192238-{random_string}': Parameter validation failed:
Invalid bucket name "web-logs-20251103192238-{random_string}": Bucket name must match the regex "^[a-zA-Z0-9.\-_]{1,255}$" or be an ARN matching the regex "^arn:(aws).*:(s3|s3-object-lambda):[a-z\-0-9]*:[0-9]{12}:accesspoint[/:][a-zA-Z0-9\-.]{1,63}$|^arn:(aws).*:s3-outposts:[a-z\-0-9]+:[0-9]{12}:outpost[/:][a-zA-Z0-9\-]{1,63}[/:]accesspoint[/:][a-zA-Z0-9\-]{1,63}$"
Failed to create S3 bucket: Parameter validation failed:
Invalid bucket name "web-logs-20251103192238-{random_string}": Bucket name must match the regex "^[a-zA-Z0-9.\-_]{1,255}$" or be an ARN matching the regex "^arn:(aws).*:(s3|s3-object-lambda):[a-z\-0-9]*:[0-9]{12}:accesspoint[/:][a-zA-Z0-9\-.]{1,63}$|^arn:(aws).*:s3-outposts:[a-z\-0-9]+:[0-9]{12}:outpost[/:][a-zA-Z0-9\-]{1,63}[/:]accesspoint[/:][a-zA-Z0-9\-]{1,63}$"
Tool 'create-s3-bucket' execution failed with error: Parameter validation failed:
Invalid bucket name "web-logs-20251103192238-{random_string}": Bucket name must match the regex "^[a-zA-Z0-9.\-_]{1,255}$" or be an ARN matching the regex "^arn:(aws).*:(s3|s3-object-lambda):[a-z\-0-9]*:[0-9]{12}:accesspoint[/:][a-zA-Z0-9\-.]{1,63}$|^arn:(aws).*:s3-outposts:[a-z\-0-9]+:[0-9]{12}:outpost[/:][a-zA-Z0-9\-]{1,63}[/:]accesspoint[/:][a-zA-Z0-9\-]{1,63}$"
An unexpected error occurred in the WebSocket handler: 'random_string'
WebSocket connection closed.
Initializing StateAwareAgent singleton...
Initializing StateManager singleton...
Initializing ToolFactory singleton...
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
ToolFactory initialized with 27 tools.
Initializing DiscoveryScanner singleton...
LLM Provider configured: gemini
LLM Model configured: gemini-2.5-flash
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
StateAwareAgent initialized.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 8 resources.
Set discovered state with 8 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-08574472bc1955da8
  Name: web-server-20251103191645
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-08574472bc1955da8, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:16:45+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-66.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.66, ProductCodes:[], PublicDnsName:, PublicIpAddress:3.8.160.191, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-0ce720e0ed16f300d, VpcId:vpc-0ce6c066ac77bb3af, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 16, 46, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-046d7f5199479de2e'}}], ClientToken:1bff7f03-1222-4fbb-ba81-a80ba3294855, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '3.8.160.191'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 16, 45, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-023f19371f4341c46', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg', 'GroupId': 'sg-00d27dd9ba9dfa933'}], 'Ipv6Addresses': [], 'MacAddress': '06:a4:77:56:2f:c5', 'NetworkInterfaceId': 'eni-0552b61863bb999de', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.66', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '3.8.160.191'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.66'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-0ce720e0ed16f300d', 'VpcId': 'vpc-0ce6c066ac77bb3af', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg', 'GroupId': 'sg-00d27dd9ba9dfa933'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:16:45+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103191645}
- ID: i-00988ca268341bd1c
  Name: web-server-20251103192236
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-00988ca268341bd1c, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:22:37+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-1-1-43.eu-west-2.compute.internal, PrivateIpAddress:10.1.1.43, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.170.223.151, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-06f0c1b6201fb0e53, VpcId:vpc-0993e8042919f98a7, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 22, 38, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-0a15884a7c6975786'}}], ClientToken:ad01e547-9d30-4ca4-a8e7-c9eec690e830, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.170.223.151'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 22, 37, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-063338df0ecc7d71b', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103192234', 'GroupId': 'sg-0b3b6c9a0c009a733'}], 'Ipv6Addresses': [], 'MacAddress': '06:2b:fd:7e:48:17', 'NetworkInterfaceId': 'eni-0cb234bdada8db87e', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.1.1.43', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.170.223.151'}, 'Primary': True, 'PrivateIpAddress': '10.1.1.43'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-06f0c1b6201fb0e53', 'VpcId': 'vpc-0993e8042919f98a7', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103192234', 'GroupId': 'sg-0b3b6c9a0c009a733'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:22:37+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192236}
- ID: vpc-0993e8042919f98a7
  Name: vpc-0993e8042919f98a7
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.1.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0993e8042919f98a7, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0d272136b687b1c87', 'CidrBlock': '10.1.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0ce6c066ac77bb3af
  Name: vpc-0ce6c066ac77bb3af
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0ce6c066ac77bb3af, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0b85506747c327845', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: sg-00d27dd9ba9dfa933
  Name: web-sg
  Type: aws_security_group
  Status: available
  Properties: {Description:Security group for web server (SSH and HTTP access), GroupName:web-sg, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-00d27dd9ba9dfa933, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}
- ID: sg-0b3b6c9a0c009a733
  Name: web-sg-20251103192234
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server in new VPC, GroupName:web-sg-20251103192234, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0b3b6c9a0c009a733, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0993e8042919f98a7}
  Tags: {}
- ID: sg-060b6eb0d2cb87d04
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-060b6eb0d2cb87d04', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-060b6eb0d2cb87d04, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0993e8042919f98a7}
  Tags: {}
- ID: sg-0d70b380cca5440ad
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0d70b380cca5440ad', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0d70b380cca5440ad, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'List Availability Zones' (ID: step-list-azs) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'List Availability Zones' completed. Result stored in context for ID 'step-list-azs'.
--- Preparing to execute step: 'Create new VPC' (ID: step-create-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.2.0.0/16', 'name': 'new-web-vpc-20251103192516'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.2.0.0/16', 'name': 'new-web-vpc-20251103192516'}
Executing CreateVpcTool with CIDR: 10.2.0.0/16
Creating VPC with CIDR block: 10.2.0.0/16
VPC created: vpc-001c002a0565a05ce
Tool 'create-vpc' executed successfully.
Step 'Create new VPC' completed. Result stored in context for ID 'step-create-vpc'.
--- Preparing to execute step: 'Create Internet Gateway' (ID: step-create-igw) ---
Executing tool 'create-internet-gateway' with resolved params: {'name': 'new-web-igw-20251103192517'}
Executing tool 'create-internet-gateway' with params: {'name': 'new-web-igw-20251103192517'}
Executing tool: create-internet-gateway
Creating Internet Gateway.
Internet Gateway created: igw-054eaf5b642952a4e
Tool 'create-internet-gateway' executed successfully.
Step 'Create Internet Gateway' completed. Result stored in context for ID 'step-create-igw'.
--- Preparing to execute step: 'Attach Internet Gateway to VPC' (ID: step-attach-igw) ---
Executing tool 'attach-internet-gateway' with resolved params: {'internet_gateway_id': 'igw-054eaf5b642952a4e', 'vpc_id': 'vpc-001c002a0565a05ce'}
Executing tool 'attach-internet-gateway' with params: {'internet_gateway_id': 'igw-054eaf5b642952a4e', 'vpc_id': 'vpc-001c002a0565a05ce'}
Executing tool: attach-internet-gateway
Attaching Internet Gateway 'igw-054eaf5b642952a4e' to VPC 'vpc-001c002a0565a05ce'.
Internet Gateway 'igw-054eaf5b642952a4e' successfully attached to VPC 'vpc-001c002a0565a05ce'.
Tool 'attach-internet-gateway' executed successfully.
Step 'Attach Internet Gateway to VPC' completed. Result stored in context for ID 'step-attach-igw'.
--- Preparing to execute step: 'Create Public Subnet' (ID: step-create-public-subnet) ---
Executing tool 'create-public-subnet' with resolved params: {'vpc_id': 'vpc-001c002a0565a05ce', 'cidr_block': '10.2.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'new-web-public-subnet-20251103192518'}
Executing tool 'create-public-subnet' with params: {'vpc_id': 'vpc-001c002a0565a05ce', 'cidr_block': '10.2.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'new-web-public-subnet-20251103192518'}
Executing tool: create-public-subnet
Creating subnet with CIDR block '10.2.1.0/24' in VPC 'vpc-001c002a0565a05ce' (AZ: eu-west-2a).
Subnet created: subnet-0e58595ea11e8dc9e
Modifying subnet 'subnet-0e58595ea11e8dc9e' to set map_public_ip_on_launch to True.
Subnet 'subnet-0e58595ea11e8dc9e' attribute modified successfully.
Tool 'create-public-subnet' executed successfully.
Step 'Create Public Subnet' completed. Result stored in context for ID 'step-create-public-subnet'.
--- Preparing to execute step: 'Create EC2 Key Pair' (ID: step-create-key-pair) ---
Executing tool 'create-key-pair' with resolved params: {'key_name': 'test-key-01'}
Executing tool 'create-key-pair' with params: {'key_name': 'test-key-01'}
Executing CreateKeyPairTool with key_name: test-key-01
Creating key pair: test-key-01
Error creating key pair 'test-key-01': An error occurred (InvalidKeyPair.Duplicate) when calling the CreateKeyPair operation: The keypair already exists
Execution failed at step 'Create EC2 Key Pair': An error occurred (InvalidKeyPair.Duplicate) when calling the CreateKeyPair operation: The keypair already exists
An unexpected error occurred in the WebSocket handler: An error occurred (InvalidKeyPair.Duplicate) when calling the CreateKeyPair operation: The keypair already exists
WebSocket connection closed.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 10 resources.
Set discovered state with 10 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-08574472bc1955da8
  Name: web-server-20251103191645
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-08574472bc1955da8, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:16:45+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:04 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:1bff7f03-1222-4fbb-ba81-a80ba3294855, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:16:45+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103191645}
- ID: i-00988ca268341bd1c
  Name: web-server-20251103192236
  Type: aws_ec2_instance
  Status: shutting-down
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-00988ca268341bd1c, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:22:37+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-1-1-43.eu-west-2.compute.internal, PrivateIpAddress:10.1.1.43, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.170.223.151, State:{'Code': 32, 'Name': 'shutting-down'}, StateTransitionReason:User initiated (2025-11-03 19:25:37 GMT), SubnetId:subnet-06f0c1b6201fb0e53, VpcId:vpc-0993e8042919f98a7, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 22, 38, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-0a15884a7c6975786'}}], ClientToken:ad01e547-9d30-4ca4-a8e7-c9eec690e830, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.170.223.151'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 22, 37, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-063338df0ecc7d71b', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103192234', 'GroupId': 'sg-0b3b6c9a0c009a733'}], 'Ipv6Addresses': [], 'MacAddress': '06:2b:fd:7e:48:17', 'NetworkInterfaceId': 'eni-0cb234bdada8db87e', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.1.1.43', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.170.223.151'}, 'Primary': True, 'PrivateIpAddress': '10.1.1.43'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-06f0c1b6201fb0e53', 'VpcId': 'vpc-0993e8042919f98a7', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103192234', 'GroupId': 'sg-0b3b6c9a0c009a733'}], SourceDestCheck:True, StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:22:37+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192236}
- ID: vpc-0993e8042919f98a7
  Name: vpc-0993e8042919f98a7
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.1.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0993e8042919f98a7, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0d272136b687b1c87', 'CidrBlock': '10.1.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0ce6c066ac77bb3af
  Name: vpc-0ce6c066ac77bb3af
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0ce6c066ac77bb3af, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0b85506747c327845', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-001c002a0565a05ce
  Name: vpc-001c002a0565a05ce
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.2.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-001c002a0565a05ce, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c73fe7e7dc6fc759', 'CidrBlock': '10.2.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: sg-00d27dd9ba9dfa933
  Name: web-sg
  Type: aws_security_group
  Status: available
  Properties: {Description:Security group for web server (SSH and HTTP access), GroupName:web-sg, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-00d27dd9ba9dfa933, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}
- ID: sg-0b3b6c9a0c009a733
  Name: web-sg-20251103192234
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server in new VPC, GroupName:web-sg-20251103192234, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0b3b6c9a0c009a733, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0993e8042919f98a7}
  Tags: {}
- ID: sg-060b6eb0d2cb87d04
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-060b6eb0d2cb87d04', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-060b6eb0d2cb87d04, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0993e8042919f98a7}
  Tags: {}
- ID: sg-0d70b380cca5440ad
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0d70b380cca5440ad', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0d70b380cca5440ad, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}
- ID: sg-02c1a080e2ebb5887
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-02c1a080e2ebb5887', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-02c1a080e2ebb5887, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-001c002a0565a05ce}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'TÃ¬m AMI Ubuntu má»›i nháº¥t' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'TÃ¬m AMI Ubuntu má»›i nháº¥t' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'Liá»‡t kÃª cÃ¡c Availability Zone' (ID: step-list-availability-zones) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'Liá»‡t kÃª cÃ¡c Availability Zone' completed. Result stored in context for ID 'step-list-availability-zones'.
--- Preparing to execute step: 'Táº¡o VPC má»›i' (ID: step-create-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.0.0.0/16', 'name': 'web-vpc-20251103192706'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.0.0.0/16', 'name': 'web-vpc-20251103192706'}
Executing CreateVpcTool with CIDR: 10.0.0.0/16
Creating VPC with CIDR block: 10.0.0.0/16
VPC created: vpc-0a55c84657c32d9ef
Tool 'create-vpc' executed successfully.
Step 'Táº¡o VPC má»›i' completed. Result stored in context for ID 'step-create-vpc'.
--- Preparing to execute step: 'Táº¡o Internet Gateway' (ID: step-create-internet-gateway) ---
Executing tool 'create-internet-gateway' with resolved params: {'name': 'web-igw-20251103192707'}
Executing tool 'create-internet-gateway' with params: {'name': 'web-igw-20251103192707'}
Executing tool: create-internet-gateway
Creating Internet Gateway.
Internet Gateway created: igw-05fec3d587a1e620a
Tool 'create-internet-gateway' executed successfully.
Step 'Táº¡o Internet Gateway' completed. Result stored in context for ID 'step-create-internet-gateway'.
--- Preparing to execute step: 'Gáº¯n Internet Gateway vÃ o VPC' (ID: step-attach-internet-gateway) ---
Executing tool 'attach-internet-gateway' with resolved params: {'vpc_id': 'vpc-0a55c84657c32d9ef', 'internet_gateway_id': 'igw-05fec3d587a1e620a'}
Executing tool 'attach-internet-gateway' with params: {'vpc_id': 'vpc-0a55c84657c32d9ef', 'internet_gateway_id': 'igw-05fec3d587a1e620a'}
Executing tool: attach-internet-gateway
Attaching Internet Gateway 'igw-05fec3d587a1e620a' to VPC 'vpc-0a55c84657c32d9ef'.
Internet Gateway 'igw-05fec3d587a1e620a' successfully attached to VPC 'vpc-0a55c84657c32d9ef'.
Tool 'attach-internet-gateway' executed successfully.
Step 'Gáº¯n Internet Gateway vÃ o VPC' completed. Result stored in context for ID 'step-attach-internet-gateway'.
--- Preparing to execute step: 'Táº¡o Public Subnet' (ID: step-create-public-subnet) ---
Executing tool 'create-public-subnet' with resolved params: {'vpc_id': 'vpc-0a55c84657c32d9ef', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-public-subnet-20251103192708', 'internet_gateway_id': 'igw-05fec3d587a1e620a'}
Executing tool 'create-public-subnet' with params: {'vpc_id': 'vpc-0a55c84657c32d9ef', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-public-subnet-20251103192708', 'internet_gateway_id': 'igw-05fec3d587a1e620a'}
Executing tool: create-public-subnet
Creating subnet with CIDR block '10.0.1.0/24' in VPC 'vpc-0a55c84657c32d9ef' (AZ: eu-west-2a).
Subnet created: subnet-01b235575503d2631
Modifying subnet 'subnet-01b235575503d2631' to set map_public_ip_on_launch to True.
Subnet 'subnet-01b235575503d2631' attribute modified successfully.
Tool 'create-public-subnet' executed successfully.
Step 'Táº¡o Public Subnet' completed. Result stored in context for ID 'step-create-public-subnet'.
--- Preparing to execute step: 'Táº¡o Key Pair 'test-key-01'' (ID: step-create-key-pair) ---
Executing tool 'create-key-pair' with resolved params: {'key_name': 'test-key-01'}
Executing tool 'create-key-pair' with params: {'key_name': 'test-key-01'}
Executing CreateKeyPairTool with key_name: test-key-01
Creating key pair: test-key-01
Tool 'create-key-pair' executed successfully.
Step 'Táº¡o Key Pair 'test-key-01'' completed. Result stored in context for ID 'step-create-key-pair'.
--- Preparing to execute step: 'Táº¡o Security Group 'web-sg'' (ID: step-create-web-sg) ---
Executing tool 'create-security-group' with resolved params: {'group_name': 'web-sg-20251103192710', 'description': 'Allow SSH and HTTP access for web server', 'vpc_id': 'vpc-0a55c84657c32d9ef'}
Executing tool 'create-security-group' with params: {'group_name': 'web-sg-20251103192710', 'description': 'Allow SSH and HTTP access for web server', 'vpc_id': 'vpc-0a55c84657c32d9ef'}
Creating security group 'web-sg-20251103192710' in VPC 'vpc-0a55c84657c32d9ef'...
Security group 'web-sg-20251103192710' created with ID: sg-068682835ed2b90e1
Security group 'web-sg-20251103192710' created with ID: sg-068682835ed2b90e1
Tool 'create-security-group' executed successfully.
Step 'Táº¡o Security Group 'web-sg'' completed. Result stored in context for ID 'step-create-web-sg'.
--- Preparing to execute step: 'ThÃªm quy táº¯c SSH vÃ o Security Group' (ID: step-add-ssh-rule) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-068682835ed2b90e1', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-068682835ed2b90e1', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-068682835ed2b90e1' for tcp:22-22 from 0.0.0.0/0...
Ingress rule added to security group 'sg-068682835ed2b90e1'.
Ingress rule added to security group 'sg-068682835ed2b90e1'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'ThÃªm quy táº¯c SSH vÃ o Security Group' completed. Result stored in context for ID 'step-add-ssh-rule'.
--- Preparing to execute step: 'ThÃªm quy táº¯c HTTP vÃ o Security Group' (ID: step-add-http-rule) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-068682835ed2b90e1', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-068682835ed2b90e1', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-068682835ed2b90e1' for tcp:80-80 from 0.0.0.0/0...
Ingress rule added to security group 'sg-068682835ed2b90e1'.
Ingress rule added to security group 'sg-068682835ed2b90e1'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'ThÃªm quy táº¯c HTTP vÃ o Security Group' completed. Result stored in context for ID 'step-add-http-rule'.
--- Preparing to execute step: 'Táº¡o EC2 Instance Ubuntu' (ID: step-create-ec2-instance) ---
Executing tool 'create-ec2-instance' with resolved params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-01', 'subnet_id': 'subnet-01b235575503d2631', 'security_group_ids': ['sg-068682835ed2b90e1'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103192713'}]}
Executing tool 'create-ec2-instance' with params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-01', 'subnet_id': 'subnet-01b235575503d2631', 'security_group_ids': ['sg-068682835ed2b90e1'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103192713'}]}
Executing tool: create-ec2-instance
Creating EC2 instance with image 'ami-0850ab57897dcaa32' and type 't3.micro'
Tool 'create-ec2-instance' executed successfully.
Step 'Táº¡o EC2 Instance Ubuntu' completed. Result stored in context for ID 'step-create-ec2-instance'.
Added/updated resource 'i-0e38c183f664ecedb' to the state.
Saved new resource 'i-0e38c183f664ecedb' of type 'aws_ec2_instance' to state.
--- Preparing to execute step: 'Táº¡o S3 Bucket Ä‘á»ƒ lÆ°u trá»¯ logs' (ID: step-create-s3-bucket) ---
Could not resolve path 'random_suffix' in context. Failed at key 'random_suffix'.
Could not resolve placeholder {random_suffix}: Could not resolve variable path 'random_suffix' in context. Debug Info: {'failed_key': 'random_suffix', 'current_value_type': 'dict', 'current_value_keys': ['step-get-ubuntu-ami', 'step-list-availability-zones', 'step-create-vpc', 'step-create-internet-gateway', 'step-attach-internet-gateway', 'step-create-public-subnet', 'step-create-key-pair', 'step-create-web-sg', 'step-add-ssh-rule', 'step-add-http-rule', 'step-create-ec2-instance'], 'attempted_pascal_case': 'RandomSuffix'}
Executing tool 'create-s3-bucket' with resolved params: {'bucket_name': 'web-logs-20251103192714-{random_suffix}'}
Executing tool 'create-s3-bucket' with params: {'bucket_name': 'web-logs-20251103192714-{random_suffix}'}
Executing CreateS3BucketTool for bucket: web-logs-20251103192714-{random_suffix}
Attempting to create S3 bucket: web-logs-20251103192714-{random-suffix}
Creating S3 bucket: web-logs-20251103192714-{random-suffix} in region: eu-west-2
Error creating S3 bucket 'web-logs-20251103192714-{random-suffix}': Parameter validation failed:
Invalid bucket name "web-logs-20251103192714-{random-suffix}": Bucket name must match the regex "^[a-zA-Z0-9.\-_]{1,255}$" or be an ARN matching the regex "^arn:(aws).*:(s3|s3-object-lambda):[a-z\-0-9]*:[0-9]{12}:accesspoint[/:][a-zA-Z0-9\-.]{1,63}$|^arn:(aws).*:s3-outposts:[a-z\-0-9]+:[0-9]{12}:outpost[/:][a-zA-Z0-9\-]{1,63}[/:]accesspoint[/:][a-zA-Z0-9\-]{1,63}$"
Failed to create S3 bucket: Parameter validation failed:
Invalid bucket name "web-logs-20251103192714-{random-suffix}": Bucket name must match the regex "^[a-zA-Z0-9.\-_]{1,255}$" or be an ARN matching the regex "^arn:(aws).*:(s3|s3-object-lambda):[a-z\-0-9]*:[0-9]{12}:accesspoint[/:][a-zA-Z0-9\-.]{1,63}$|^arn:(aws).*:s3-outposts:[a-z\-0-9]+:[0-9]{12}:outpost[/:][a-zA-Z0-9\-]{1,63}[/:]accesspoint[/:][a-zA-Z0-9\-]{1,63}$"
Tool 'create-s3-bucket' execution failed with error: Parameter validation failed:
Invalid bucket name "web-logs-20251103192714-{random-suffix}": Bucket name must match the regex "^[a-zA-Z0-9.\-_]{1,255}$" or be an ARN matching the regex "^arn:(aws).*:(s3|s3-object-lambda):[a-z\-0-9]*:[0-9]{12}:accesspoint[/:][a-zA-Z0-9\-.]{1,63}$|^arn:(aws).*:s3-outposts:[a-z\-0-9]+:[0-9]{12}:outpost[/:][a-zA-Z0-9\-]{1,63}[/:]accesspoint[/:][a-zA-Z0-9\-]{1,63}$"
An unexpected error occurred in the WebSocket handler: 'random-suffix'
WebSocket connection closed.
Initializing StateAwareAgent singleton...
Initializing StateManager singleton...
Initializing ToolFactory singleton...
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
ToolFactory initialized with 27 tools.
Initializing DiscoveryScanner singleton...
LLM Provider configured: gemini
LLM Model configured: gemini-2.5-flash
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
StateAwareAgent initialized.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 14 resources.
Set discovered state with 14 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-08574472bc1955da8
  Name: web-server-20251103191645
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-08574472bc1955da8, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:16:45+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:04 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:1bff7f03-1222-4fbb-ba81-a80ba3294855, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:16:45+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103191645}
- ID: i-0e38c183f664ecedb
  Name: web-server-20251103192713
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-0e38c183f664ecedb, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:27:14+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-26.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.26, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.171.165.34, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-01b235575503d2631, VpcId:vpc-0a55c84657c32d9ef, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-05c1eaaea0c9393aa'}}], ClientToken:53dead58-5746-493a-99e8-88000c24f3a0, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-09e688a63dfb51611', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], 'Ipv6Addresses': [], 'MacAddress': '06:8e:27:15:d9:2b', 'NetworkInterfaceId': 'eni-072c65cda8bef8c0b', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.26', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.26'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-01b235575503d2631', 'VpcId': 'vpc-0a55c84657c32d9ef', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:27:14+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192713}
- ID: i-00988ca268341bd1c
  Name: web-server-20251103192236
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-00988ca268341bd1c, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:22:37+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:37 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:ad01e547-9d30-4ca4-a8e7-c9eec690e830, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:22:37+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192236}
- ID: vpc-0993e8042919f98a7
  Name: vpc-0993e8042919f98a7
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.1.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0993e8042919f98a7, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0d272136b687b1c87', 'CidrBlock': '10.1.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0a55c84657c32d9ef
  Name: vpc-0a55c84657c32d9ef
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0a55c84657c32d9ef, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c89a5d3fca263cf1', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0ce6c066ac77bb3af
  Name: vpc-0ce6c066ac77bb3af
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0ce6c066ac77bb3af, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0b85506747c327845', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-001c002a0565a05ce
  Name: vpc-001c002a0565a05ce
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.2.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-001c002a0565a05ce, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c73fe7e7dc6fc759', 'CidrBlock': '10.2.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: sg-00d27dd9ba9dfa933
  Name: web-sg
  Type: aws_security_group
  Status: available
  Properties: {Description:Security group for web server (SSH and HTTP access), GroupName:web-sg, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-00d27dd9ba9dfa933, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}
- ID: sg-0b3b6c9a0c009a733
  Name: web-sg-20251103192234
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server in new VPC, GroupName:web-sg-20251103192234, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0b3b6c9a0c009a733, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0993e8042919f98a7}
  Tags: {}
- ID: sg-068682835ed2b90e1
  Name: web-sg-20251103192710
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103192710, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-068682835ed2b90e1, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}
- ID: sg-060b6eb0d2cb87d04
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-060b6eb0d2cb87d04', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-060b6eb0d2cb87d04, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0993e8042919f98a7}
  Tags: {}
- ID: sg-0d70b380cca5440ad
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0d70b380cca5440ad', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0d70b380cca5440ad, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}
- ID: sg-02c1a080e2ebb5887
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-02c1a080e2ebb5887', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-02c1a080e2ebb5887, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-001c002a0565a05ce}
  Tags: {}
- ID: sg-0e94dd64535c0ef45
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e94dd64535c0ef45', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e94dd64535c0ef45, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'List Availability Zones' (ID: step-list-azs) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'List Availability Zones' completed. Result stored in context for ID 'step-list-azs'.
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'Create new VPC' (ID: step-create-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.10.0.0/16', 'name': 'web-env-vpc-20251103193020'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.10.0.0/16', 'name': 'web-env-vpc-20251103193020'}
Executing CreateVpcTool with CIDR: 10.10.0.0/16
Creating VPC with CIDR block: 10.10.0.0/16
VPC created: vpc-02f1aa392704ff989
Tool 'create-vpc' executed successfully.
Step 'Create new VPC' completed. Result stored in context for ID 'step-create-vpc'.
--- Preparing to execute step: 'Create Internet Gateway' (ID: step-create-igw) ---
Executing tool 'create-internet-gateway' with resolved params: {'name': 'web-env-igw-20251103193022'}
Executing tool 'create-internet-gateway' with params: {'name': 'web-env-igw-20251103193022'}
Executing tool: create-internet-gateway
Creating Internet Gateway.
Internet Gateway created: igw-086e9610956c9cb7f
Tool 'create-internet-gateway' executed successfully.
Step 'Create Internet Gateway' completed. Result stored in context for ID 'step-create-igw'.
--- Preparing to execute step: 'Attach Internet Gateway to VPC' (ID: step-attach-igw) ---
Executing tool 'attach-internet-gateway' with resolved params: {'vpc_id': 'vpc-02f1aa392704ff989', 'internet_gateway_id': 'igw-086e9610956c9cb7f'}
Executing tool 'attach-internet-gateway' with params: {'vpc_id': 'vpc-02f1aa392704ff989', 'internet_gateway_id': 'igw-086e9610956c9cb7f'}
Executing tool: attach-internet-gateway
Attaching Internet Gateway 'igw-086e9610956c9cb7f' to VPC 'vpc-02f1aa392704ff989'.
Internet Gateway 'igw-086e9610956c9cb7f' successfully attached to VPC 'vpc-02f1aa392704ff989'.
Tool 'attach-internet-gateway' executed successfully.
Step 'Attach Internet Gateway to VPC' completed. Result stored in context for ID 'step-attach-igw'.
--- Preparing to execute step: 'Create Public Subnet' (ID: step-create-public-subnet) ---
Executing tool 'create-public-subnet' with resolved params: {'vpc_id': 'vpc-02f1aa392704ff989', 'cidr_block': '10.10.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-env-public-subnet-20251103193022'}
Executing tool 'create-public-subnet' with params: {'vpc_id': 'vpc-02f1aa392704ff989', 'cidr_block': '10.10.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-env-public-subnet-20251103193022'}
Executing tool: create-public-subnet
Creating subnet with CIDR block '10.10.1.0/24' in VPC 'vpc-02f1aa392704ff989' (AZ: eu-west-2a).
Subnet created: subnet-01d7e6656bcdef0d0
Modifying subnet 'subnet-01d7e6656bcdef0d0' to set map_public_ip_on_launch to True.
Subnet 'subnet-01d7e6656bcdef0d0' attribute modified successfully.
Tool 'create-public-subnet' executed successfully.
Step 'Create Public Subnet' completed. Result stored in context for ID 'step-create-public-subnet'.
--- Preparing to execute step: 'Create EC2 Key Pair 'test-key-01'' (ID: step-create-key-pair) ---
Executing tool 'create-key-pair' with resolved params: {'key_name': 'test-key-01'}
Executing tool 'create-key-pair' with params: {'key_name': 'test-key-01'}
Executing CreateKeyPairTool with key_name: test-key-01
Creating key pair: test-key-01
Error creating key pair 'test-key-01': An error occurred (InvalidKeyPair.Duplicate) when calling the CreateKeyPair operation: The keypair already exists
Execution failed at step 'Create EC2 Key Pair 'test-key-01'': An error occurred (InvalidKeyPair.Duplicate) when calling the CreateKeyPair operation: The keypair already exists
An unexpected error occurred in the WebSocket handler: An error occurred (InvalidKeyPair.Duplicate) when calling the CreateKeyPair operation: The keypair already exists
WebSocket connection closed.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 16 resources.
Set discovered state with 16 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-08574472bc1955da8
  Name: web-server-20251103191645
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-08574472bc1955da8, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:16:45+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:04 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:1bff7f03-1222-4fbb-ba81-a80ba3294855, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:16:45+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103191645}
- ID: i-0e38c183f664ecedb
  Name: web-server-20251103192713
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-0e38c183f664ecedb, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:27:14+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-26.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.26, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.171.165.34, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-01b235575503d2631, VpcId:vpc-0a55c84657c32d9ef, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-05c1eaaea0c9393aa'}}], ClientToken:53dead58-5746-493a-99e8-88000c24f3a0, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-09e688a63dfb51611', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], 'Ipv6Addresses': [], 'MacAddress': '06:8e:27:15:d9:2b', 'NetworkInterfaceId': 'eni-072c65cda8bef8c0b', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.26', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.26'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-01b235575503d2631', 'VpcId': 'vpc-0a55c84657c32d9ef', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:27:14+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192713}
- ID: i-00988ca268341bd1c
  Name: web-server-20251103192236
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-00988ca268341bd1c, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:22:37+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:37 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:ad01e547-9d30-4ca4-a8e7-c9eec690e830, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:22:37+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192236}
- ID: vpc-0993e8042919f98a7
  Name: vpc-0993e8042919f98a7
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.1.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0993e8042919f98a7, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0d272136b687b1c87', 'CidrBlock': '10.1.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-02f1aa392704ff989
  Name: vpc-02f1aa392704ff989
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.10.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-02f1aa392704ff989, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0475cfecc66c03db1', 'CidrBlock': '10.10.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0a55c84657c32d9ef
  Name: vpc-0a55c84657c32d9ef
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0a55c84657c32d9ef, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c89a5d3fca263cf1', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0ce6c066ac77bb3af
  Name: vpc-0ce6c066ac77bb3af
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0ce6c066ac77bb3af, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0b85506747c327845', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-001c002a0565a05ce
  Name: vpc-001c002a0565a05ce
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.2.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-001c002a0565a05ce, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c73fe7e7dc6fc759', 'CidrBlock': '10.2.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: sg-00d27dd9ba9dfa933
  Name: web-sg
  Type: aws_security_group
  Status: available
  Properties: {Description:Security group for web server (SSH and HTTP access), GroupName:web-sg, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-00d27dd9ba9dfa933, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}
- ID: sg-0e77cfd3c5f50dc0b
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e77cfd3c5f50dc0b', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e77cfd3c5f50dc0b, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-02f1aa392704ff989}
  Tags: {}
- ID: sg-0b3b6c9a0c009a733
  Name: web-sg-20251103192234
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server in new VPC, GroupName:web-sg-20251103192234, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0b3b6c9a0c009a733, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0993e8042919f98a7}
  Tags: {}
- ID: sg-068682835ed2b90e1
  Name: web-sg-20251103192710
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103192710, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-068682835ed2b90e1, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}
- ID: sg-060b6eb0d2cb87d04
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-060b6eb0d2cb87d04', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-060b6eb0d2cb87d04, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0993e8042919f98a7}
  Tags: {}
- ID: sg-0d70b380cca5440ad
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0d70b380cca5440ad', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0d70b380cca5440ad, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0ce6c066ac77bb3af}
  Tags: {}
- ID: sg-02c1a080e2ebb5887
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-02c1a080e2ebb5887', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-02c1a080e2ebb5887, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-001c002a0565a05ce}
  Tags: {}
- ID: sg-0e94dd64535c0ef45
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e94dd64535c0ef45', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e94dd64535c0ef45, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'List Availability Zones' (ID: step-list-azs) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'List Availability Zones' completed. Result stored in context for ID 'step-list-azs'.
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'Create new VPC' (ID: step-create-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.0.0.0/16', 'name': 'web-env-vpc-20251103193203'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.0.0.0/16', 'name': 'web-env-vpc-20251103193203'}
Executing CreateVpcTool with CIDR: 10.0.0.0/16
Creating VPC with CIDR block: 10.0.0.0/16
Error creating VPC: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
Failed to create VPC: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
Tool 'create-vpc' execution failed with error: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
Execution failed at step 'Create new VPC': Tool 'create-vpc' execution failed: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
An unexpected error occurred in the WebSocket handler: Tool 'create-vpc' execution failed: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
WebSocket connection closed.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 8 resources.
Set discovered state with 8 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-01'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-08574472bc1955da8
  Name: web-server-20251103191645
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-08574472bc1955da8, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:16:45+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:04 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:1bff7f03-1222-4fbb-ba81-a80ba3294855, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:16:45+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103191645}
- ID: i-0e38c183f664ecedb
  Name: web-server-20251103192713
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-0e38c183f664ecedb, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:27:14+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-26.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.26, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.171.165.34, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-01b235575503d2631, VpcId:vpc-0a55c84657c32d9ef, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-05c1eaaea0c9393aa'}}], ClientToken:53dead58-5746-493a-99e8-88000c24f3a0, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-09e688a63dfb51611', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], 'Ipv6Addresses': [], 'MacAddress': '06:8e:27:15:d9:2b', 'NetworkInterfaceId': 'eni-072c65cda8bef8c0b', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.26', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.26'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-01b235575503d2631', 'VpcId': 'vpc-0a55c84657c32d9ef', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:27:14+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192713}
- ID: i-00988ca268341bd1c
  Name: web-server-20251103192236
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-00988ca268341bd1c, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:22:37+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:37 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:ad01e547-9d30-4ca4-a8e7-c9eec690e830, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:22:37+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192236}
- ID: vpc-02f1aa392704ff989
  Name: vpc-02f1aa392704ff989
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.10.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-02f1aa392704ff989, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0475cfecc66c03db1', 'CidrBlock': '10.10.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0a55c84657c32d9ef
  Name: vpc-0a55c84657c32d9ef
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0a55c84657c32d9ef, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c89a5d3fca263cf1', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: sg-0e77cfd3c5f50dc0b
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e77cfd3c5f50dc0b', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e77cfd3c5f50dc0b, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-02f1aa392704ff989}
  Tags: {}
- ID: sg-068682835ed2b90e1
  Name: web-sg-20251103192710
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103192710, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-068682835ed2b90e1, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}
- ID: sg-0e94dd64535c0ef45
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e94dd64535c0ef45', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e94dd64535c0ef45, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'List Availability Zones' (ID: step-list-availability-zones) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'List Availability Zones' completed. Result stored in context for ID 'step-list-availability-zones'.
--- Preparing to execute step: 'Create new VPC' (ID: step-create-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.0.0.0/16', 'name': 'web-env-vpc-20251103193337'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.0.0.0/16', 'name': 'web-env-vpc-20251103193337'}
Executing CreateVpcTool with CIDR: 10.0.0.0/16
Creating VPC with CIDR block: 10.0.0.0/16
VPC created: vpc-072f37b6be5080d20
Tool 'create-vpc' executed successfully.
Step 'Create new VPC' completed. Result stored in context for ID 'step-create-vpc'.
--- Preparing to execute step: 'Create Internet Gateway' (ID: step-create-internet-gateway) ---
Executing tool 'create-internet-gateway' with resolved params: {'name': 'web-env-igw-20251103193339'}
Executing tool 'create-internet-gateway' with params: {'name': 'web-env-igw-20251103193339'}
Executing tool: create-internet-gateway
Creating Internet Gateway.
Internet Gateway created: igw-04d525605e4d4732e
Tool 'create-internet-gateway' executed successfully.
Step 'Create Internet Gateway' completed. Result stored in context for ID 'step-create-internet-gateway'.
--- Preparing to execute step: 'Attach Internet Gateway to VPC' (ID: step-attach-internet-gateway) ---
Executing tool 'attach-internet-gateway' with resolved params: {'internet_gateway_id': 'igw-04d525605e4d4732e', 'vpc_id': 'vpc-072f37b6be5080d20'}
Executing tool 'attach-internet-gateway' with params: {'internet_gateway_id': 'igw-04d525605e4d4732e', 'vpc_id': 'vpc-072f37b6be5080d20'}
Executing tool: attach-internet-gateway
Attaching Internet Gateway 'igw-04d525605e4d4732e' to VPC 'vpc-072f37b6be5080d20'.
Internet Gateway 'igw-04d525605e4d4732e' successfully attached to VPC 'vpc-072f37b6be5080d20'.
Tool 'attach-internet-gateway' executed successfully.
Step 'Attach Internet Gateway to VPC' completed. Result stored in context for ID 'step-attach-internet-gateway'.
--- Preparing to execute step: 'Create Public Subnet' (ID: step-create-public-subnet) ---
Executing tool 'create-public-subnet' with resolved params: {'vpc_id': 'vpc-072f37b6be5080d20', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-env-public-subnet-20251103193340'}
Executing tool 'create-public-subnet' with params: {'vpc_id': 'vpc-072f37b6be5080d20', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-env-public-subnet-20251103193340'}
Executing tool: create-public-subnet
Creating subnet with CIDR block '10.0.1.0/24' in VPC 'vpc-072f37b6be5080d20' (AZ: eu-west-2a).
Subnet created: subnet-0d534a28b9690ae7c
Modifying subnet 'subnet-0d534a28b9690ae7c' to set map_public_ip_on_launch to True.
Subnet 'subnet-0d534a28b9690ae7c' attribute modified successfully.
Tool 'create-public-subnet' executed successfully.
Step 'Create Public Subnet' completed. Result stored in context for ID 'step-create-public-subnet'.
--- Preparing to execute step: 'Create web-sg Security Group' (ID: step-create-security-group) ---
Executing tool 'create-security-group' with resolved params: {'group_name': 'web-sg-20251103193341', 'description': 'Allow SSH and HTTP access for web server', 'vpc_id': 'vpc-072f37b6be5080d20'}
Executing tool 'create-security-group' with params: {'group_name': 'web-sg-20251103193341', 'description': 'Allow SSH and HTTP access for web server', 'vpc_id': 'vpc-072f37b6be5080d20'}
Creating security group 'web-sg-20251103193341' in VPC 'vpc-072f37b6be5080d20'...
Security group 'web-sg-20251103193341' created with ID: sg-0b72528100fbe8490
Security group 'web-sg-20251103193341' created with ID: sg-0b72528100fbe8490
Tool 'create-security-group' executed successfully.
Step 'Create web-sg Security Group' completed. Result stored in context for ID 'step-create-security-group'.
--- Preparing to execute step: 'Add SSH Ingress Rule' (ID: step-add-ssh-ingress) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-0b72528100fbe8490', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-0b72528100fbe8490', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-0b72528100fbe8490' for tcp:22-22 from 0.0.0.0/0...
Ingress rule added to security group 'sg-0b72528100fbe8490'.
Ingress rule added to security group 'sg-0b72528100fbe8490'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add SSH Ingress Rule' completed. Result stored in context for ID 'step-add-ssh-ingress'.
--- Preparing to execute step: 'Add HTTP Ingress Rule' (ID: step-add-http-ingress) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-0b72528100fbe8490', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-0b72528100fbe8490', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-0b72528100fbe8490' for tcp:80-80 from 0.0.0.0/0...
Ingress rule added to security group 'sg-0b72528100fbe8490'.
Ingress rule added to security group 'sg-0b72528100fbe8490'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add HTTP Ingress Rule' completed. Result stored in context for ID 'step-add-http-ingress'.
--- Preparing to execute step: 'Create EC2 Instance' (ID: step-create-ec2-instance) ---
Executing tool 'create-ec2-instance' with resolved params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-01', 'subnet_id': 'subnet-0d534a28b9690ae7c', 'security_group_ids': ['sg-0b72528100fbe8490'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103193344'}]}
Executing tool 'create-ec2-instance' with params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-01', 'subnet_id': 'subnet-0d534a28b9690ae7c', 'security_group_ids': ['sg-0b72528100fbe8490'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103193344'}]}
Executing tool: create-ec2-instance
Creating EC2 instance with image 'ami-0850ab57897dcaa32' and type 't3.micro'
Error creating EC2 instance: An error occurred (InvalidKeyPair.NotFound) when calling the RunInstances operation: The key pair 'test-key-01' does not exist
Execution failed at step 'Create EC2 Instance': An error occurred (InvalidKeyPair.NotFound) when calling the RunInstances operation: The key pair 'test-key-01' does not exist
An unexpected error occurred in the WebSocket handler: An error occurred (InvalidKeyPair.NotFound) when calling the RunInstances operation: The key pair 'test-key-01' does not exist
WebSocket connection closed.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-02'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 11 resources.
Set discovered state with 11 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-02'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-08574472bc1955da8
  Name: web-server-20251103191645
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-08574472bc1955da8, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:16:45+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:04 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:1bff7f03-1222-4fbb-ba81-a80ba3294855, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:16:45+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103191645}
- ID: i-0e38c183f664ecedb
  Name: web-server-20251103192713
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-0e38c183f664ecedb, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:27:14+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-26.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.26, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.171.165.34, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-01b235575503d2631, VpcId:vpc-0a55c84657c32d9ef, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-05c1eaaea0c9393aa'}}], ClientToken:53dead58-5746-493a-99e8-88000c24f3a0, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-09e688a63dfb51611', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], 'Ipv6Addresses': [], 'MacAddress': '06:8e:27:15:d9:2b', 'NetworkInterfaceId': 'eni-072c65cda8bef8c0b', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.26', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.26'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-01b235575503d2631', 'VpcId': 'vpc-0a55c84657c32d9ef', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:27:14+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192713}
- ID: i-00988ca268341bd1c
  Name: web-server-20251103192236
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-00988ca268341bd1c, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:22:37+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:37 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:ad01e547-9d30-4ca4-a8e7-c9eec690e830, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:22:37+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192236}
- ID: vpc-02f1aa392704ff989
  Name: vpc-02f1aa392704ff989
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.10.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-02f1aa392704ff989, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0475cfecc66c03db1', 'CidrBlock': '10.10.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0a55c84657c32d9ef
  Name: vpc-0a55c84657c32d9ef
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0a55c84657c32d9ef, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c89a5d3fca263cf1', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-072f37b6be5080d20
  Name: vpc-072f37b6be5080d20
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-072f37b6be5080d20, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-075dd6d69422584c1', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: sg-0e77cfd3c5f50dc0b
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e77cfd3c5f50dc0b', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e77cfd3c5f50dc0b, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-02f1aa392704ff989}
  Tags: {}
- ID: sg-0b72528100fbe8490
  Name: web-sg-20251103193341
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103193341, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0b72528100fbe8490, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-072f37b6be5080d20}
  Tags: {}
- ID: sg-0691977ddfd2a2c0b
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0691977ddfd2a2c0b', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0691977ddfd2a2c0b, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-072f37b6be5080d20}
  Tags: {}
- ID: sg-068682835ed2b90e1
  Name: web-sg-20251103192710
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103192710, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-068682835ed2b90e1, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}
- ID: sg-0e94dd64535c0ef45
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e94dd64535c0ef45', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e94dd64535c0ef45, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'List Availability Zones' (ID: step-list-azs) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'List Availability Zones' completed. Result stored in context for ID 'step-list-azs'.
--- Preparing to execute step: 'Create new VPC' (ID: step-create-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.0.0.0/16', 'name': 'web-env-vpc-20251103193429'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.0.0.0/16', 'name': 'web-env-vpc-20251103193429'}
Executing CreateVpcTool with CIDR: 10.0.0.0/16
Creating VPC with CIDR block: 10.0.0.0/16
VPC created: vpc-0089d124f33a3f79f
Tool 'create-vpc' executed successfully.
Step 'Create new VPC' completed. Result stored in context for ID 'step-create-vpc'.
--- Preparing to execute step: 'Create Internet Gateway' (ID: step-create-internet-gateway) ---
Executing tool 'create-internet-gateway' with resolved params: {'name': 'web-env-igw-20251103193430'}
Executing tool 'create-internet-gateway' with params: {'name': 'web-env-igw-20251103193430'}
Executing tool: create-internet-gateway
Creating Internet Gateway.
Internet Gateway created: igw-0da0e99afcc6c82b4
Tool 'create-internet-gateway' executed successfully.
Step 'Create Internet Gateway' completed. Result stored in context for ID 'step-create-internet-gateway'.
--- Preparing to execute step: 'Attach Internet Gateway to VPC' (ID: step-attach-internet-gateway) ---
Executing tool 'attach-internet-gateway' with resolved params: {'internet_gateway_id': 'igw-0da0e99afcc6c82b4', 'vpc_id': 'vpc-0089d124f33a3f79f'}
Executing tool 'attach-internet-gateway' with params: {'internet_gateway_id': 'igw-0da0e99afcc6c82b4', 'vpc_id': 'vpc-0089d124f33a3f79f'}
Executing tool: attach-internet-gateway
Attaching Internet Gateway 'igw-0da0e99afcc6c82b4' to VPC 'vpc-0089d124f33a3f79f'.
Internet Gateway 'igw-0da0e99afcc6c82b4' successfully attached to VPC 'vpc-0089d124f33a3f79f'.
Tool 'attach-internet-gateway' executed successfully.
Step 'Attach Internet Gateway to VPC' completed. Result stored in context for ID 'step-attach-internet-gateway'.
--- Preparing to execute step: 'Create Public Subnet' (ID: step-create-public-subnet) ---
Executing tool 'create-public-subnet' with resolved params: {'vpc_id': 'vpc-0089d124f33a3f79f', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-env-public-subnet-20251103193431'}
Executing tool 'create-public-subnet' with params: {'vpc_id': 'vpc-0089d124f33a3f79f', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-env-public-subnet-20251103193431'}
Executing tool: create-public-subnet
Creating subnet with CIDR block '10.0.1.0/24' in VPC 'vpc-0089d124f33a3f79f' (AZ: eu-west-2a).
Subnet created: subnet-0899c950c98523529
Modifying subnet 'subnet-0899c950c98523529' to set map_public_ip_on_launch to True.
Subnet 'subnet-0899c950c98523529' attribute modified successfully.
Tool 'create-public-subnet' executed successfully.
Step 'Create Public Subnet' completed. Result stored in context for ID 'step-create-public-subnet'.
--- Preparing to execute step: 'Create EC2 Key Pair' (ID: step-create-key-pair) ---
Executing tool 'create-key-pair' with resolved params: {'key_name': 'test-key-02'}
Executing tool 'create-key-pair' with params: {'key_name': 'test-key-02'}
Executing CreateKeyPairTool with key_name: test-key-02
Creating key pair: test-key-02
Tool 'create-key-pair' executed successfully.
Step 'Create EC2 Key Pair' completed. Result stored in context for ID 'step-create-key-pair'.
--- Preparing to execute step: 'Create Web Security Group' (ID: step-create-security-group) ---
Executing tool 'create-security-group' with resolved params: {'group_name': 'web-sg-20251103193433', 'description': 'Allow SSH and HTTP access for web server', 'vpc_id': 'vpc-0089d124f33a3f79f'}
Executing tool 'create-security-group' with params: {'group_name': 'web-sg-20251103193433', 'description': 'Allow SSH and HTTP access for web server', 'vpc_id': 'vpc-0089d124f33a3f79f'}
Creating security group 'web-sg-20251103193433' in VPC 'vpc-0089d124f33a3f79f'...
Security group 'web-sg-20251103193433' created with ID: sg-0aa99920e318585ea
Security group 'web-sg-20251103193433' created with ID: sg-0aa99920e318585ea
Tool 'create-security-group' executed successfully.
Step 'Create Web Security Group' completed. Result stored in context for ID 'step-create-security-group'.
--- Preparing to execute step: 'Add SSH Ingress Rule' (ID: step-add-ssh-ingress) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-0aa99920e318585ea', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-0aa99920e318585ea', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-0aa99920e318585ea' for tcp:22-22 from 0.0.0.0/0...
Ingress rule added to security group 'sg-0aa99920e318585ea'.
Ingress rule added to security group 'sg-0aa99920e318585ea'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add SSH Ingress Rule' completed. Result stored in context for ID 'step-add-ssh-ingress'.
--- Preparing to execute step: 'Add HTTP Ingress Rule' (ID: step-add-http-ingress) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-0aa99920e318585ea', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-0aa99920e318585ea', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-0aa99920e318585ea' for tcp:80-80 from 0.0.0.0/0...
Ingress rule added to security group 'sg-0aa99920e318585ea'.
Ingress rule added to security group 'sg-0aa99920e318585ea'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add HTTP Ingress Rule' completed. Result stored in context for ID 'step-add-http-ingress'.
--- Preparing to execute step: 'Create EC2 Instance' (ID: step-create-ec2-instance) ---
Executing tool 'create-ec2-instance' with resolved params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-02', 'subnet_id': 'subnet-0899c950c98523529', 'security_group_ids': ['sg-0aa99920e318585ea'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103193434'}]}
Executing tool 'create-ec2-instance' with params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-02', 'subnet_id': 'subnet-0899c950c98523529', 'security_group_ids': ['sg-0aa99920e318585ea'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103193434'}]}
Executing tool: create-ec2-instance
Creating EC2 instance with image 'ami-0850ab57897dcaa32' and type 't3.micro'
Tool 'create-ec2-instance' executed successfully.
Step 'Create EC2 Instance' completed. Result stored in context for ID 'step-create-ec2-instance'.
Added/updated resource 'i-095e5af35d4722033' to the state.
Saved new resource 'i-095e5af35d4722033' of type 'aws_ec2_instance' to state.
--- Preparing to execute step: 'Create S3 Bucket for Logs' (ID: step-create-s3-bucket) ---
Executing tool 'create-s3-bucket' with resolved params: {'bucket_name': 'web-env-logs-20251103193435'}
Executing tool 'create-s3-bucket' with params: {'bucket_name': 'web-env-logs-20251103193435'}
Executing CreateS3BucketTool for bucket: web-env-logs-20251103193435
Attempting to create S3 bucket: web-env-logs-20251103193435
Creating S3 bucket: web-env-logs-20251103193435 in region: eu-west-2
Error creating S3 bucket 'web-env-logs-20251103193435': An error occurred (IllegalLocationConstraintException) when calling the CreateBucket operation: The unspecified location constraint is incompatible for the region specific endpoint this request was sent to.
Failed to create S3 bucket: An error occurred (IllegalLocationConstraintException) when calling the CreateBucket operation: The unspecified location constraint is incompatible for the region specific endpoint this request was sent to.
Tool 'create-s3-bucket' execution failed with error: An error occurred (IllegalLocationConstraintException) when calling the CreateBucket operation: The unspecified location constraint is incompatible for the region specific endpoint this request was sent to.
Execution failed at step 'Create S3 Bucket for Logs': Tool 'create-s3-bucket' execution failed: An error occurred (IllegalLocationConstraintException) when calling the CreateBucket operation: The unspecified location constraint is incompatible for the region specific endpoint this request was sent to.
An unexpected error occurred in the WebSocket handler: Tool 'create-s3-bucket' execution failed: An error occurred (IllegalLocationConstraintException) when calling the CreateBucket operation: The unspecified location constraint is incompatible for the region specific endpoint this request was sent to.
WebSocket connection closed.
Initializing StateAwareAgent singleton...
Initializing StateManager singleton...
Initializing ToolFactory singleton...
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
ToolFactory initialized with 27 tools.
Initializing DiscoveryScanner singleton...
LLM Provider configured: gemini
LLM Model configured: gemini-2.5-flash
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
StateAwareAgent initialized.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-03'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 15 resources.
Set discovered state with 15 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-03'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-08574472bc1955da8
  Name: web-server-20251103191645
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-08574472bc1955da8, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:16:45+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:04 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:1bff7f03-1222-4fbb-ba81-a80ba3294855, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:16:45+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103191645}
- ID: i-0e38c183f664ecedb
  Name: web-server-20251103192713
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-0e38c183f664ecedb, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:27:14+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-26.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.26, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.171.165.34, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-01b235575503d2631, VpcId:vpc-0a55c84657c32d9ef, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-05c1eaaea0c9393aa'}}], ClientToken:53dead58-5746-493a-99e8-88000c24f3a0, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-09e688a63dfb51611', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], 'Ipv6Addresses': [], 'MacAddress': '06:8e:27:15:d9:2b', 'NetworkInterfaceId': 'eni-072c65cda8bef8c0b', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.26', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.26'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-01b235575503d2631', 'VpcId': 'vpc-0a55c84657c32d9ef', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:27:14+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192713}
- ID: i-00988ca268341bd1c
  Name: web-server-20251103192236
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-00988ca268341bd1c, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:22:37+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:37 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:ad01e547-9d30-4ca4-a8e7-c9eec690e830, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:22:37+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192236}
- ID: i-095e5af35d4722033
  Name: web-server-20251103193434
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-095e5af35d4722033, InstanceType:t3.micro, KeyName:test-key-02, LaunchTime:2025-11-03 19:34:35+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-207.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.207, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.130.105.106, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-0899c950c98523529, VpcId:vpc-0089d124f33a3f79f, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 34, 35, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-0b4ac4deed165f1dc'}}], ClientToken:b2614316-b669-43c1-b681-c0f4a8ede054, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.130.105.106'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 34, 35, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-00f7b69d1e764fdd9', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103193433', 'GroupId': 'sg-0aa99920e318585ea'}], 'Ipv6Addresses': [], 'MacAddress': '06:13:b0:e9:e1:f7', 'NetworkInterfaceId': 'eni-03826b9ba2393127b', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.207', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.130.105.106'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.207'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-0899c950c98523529', 'VpcId': 'vpc-0089d124f33a3f79f', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103193433', 'GroupId': 'sg-0aa99920e318585ea'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:34:35+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103193434}
- ID: vpc-0089d124f33a3f79f
  Name: vpc-0089d124f33a3f79f
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0089d124f33a3f79f, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-063e90ba075100090', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-02f1aa392704ff989
  Name: vpc-02f1aa392704ff989
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.10.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-02f1aa392704ff989, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0475cfecc66c03db1', 'CidrBlock': '10.10.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0a55c84657c32d9ef
  Name: vpc-0a55c84657c32d9ef
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0a55c84657c32d9ef, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c89a5d3fca263cf1', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-072f37b6be5080d20
  Name: vpc-072f37b6be5080d20
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-072f37b6be5080d20, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-075dd6d69422584c1', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: sg-0aa99920e318585ea
  Name: web-sg-20251103193433
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103193433, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0aa99920e318585ea, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0089d124f33a3f79f}
  Tags: {}
- ID: sg-0e77cfd3c5f50dc0b
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e77cfd3c5f50dc0b', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e77cfd3c5f50dc0b, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-02f1aa392704ff989}
  Tags: {}
- ID: sg-0b72528100fbe8490
  Name: web-sg-20251103193341
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103193341, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0b72528100fbe8490, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-072f37b6be5080d20}
  Tags: {}
- ID: sg-0c6dd4234ea8a4c8e
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0c6dd4234ea8a4c8e', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0c6dd4234ea8a4c8e, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0089d124f33a3f79f}
  Tags: {}
- ID: sg-0691977ddfd2a2c0b
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0691977ddfd2a2c0b', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0691977ddfd2a2c0b, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-072f37b6be5080d20}
  Tags: {}
- ID: sg-068682835ed2b90e1
  Name: web-sg-20251103192710
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103192710, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-068682835ed2b90e1, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}
- ID: sg-0e94dd64535c0ef45
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e94dd64535c0ef45', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e94dd64535c0ef45, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'List Availability Zones' (ID: step-list-azs) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'List Availability Zones' completed. Result stored in context for ID 'step-list-azs'.
--- Preparing to execute step: 'Create new VPC' (ID: step-create-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.0.0.0/16', 'name': 'web-env-vpc-20251103193750'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.0.0.0/16', 'name': 'web-env-vpc-20251103193750'}
Executing CreateVpcTool with CIDR: 10.0.0.0/16
Creating VPC with CIDR block: 10.0.0.0/16
VPC created: vpc-04f6ca5d65139bd59
Tool 'create-vpc' executed successfully.
Step 'Create new VPC' completed. Result stored in context for ID 'step-create-vpc'.
--- Preparing to execute step: 'Create Internet Gateway' (ID: step-create-internet-gateway) ---
Executing tool 'create-internet-gateway' with resolved params: {'vpc_id': 'vpc-04f6ca5d65139bd59', 'name': 'web-env-igw-20251103193751'}
Executing tool 'create-internet-gateway' with params: {'vpc_id': 'vpc-04f6ca5d65139bd59', 'name': 'web-env-igw-20251103193751'}
Executing tool: create-internet-gateway
Creating Internet Gateway.
Internet Gateway created: igw-057be1ccd756ac835
Tool 'create-internet-gateway' executed successfully.
Step 'Create Internet Gateway' completed. Result stored in context for ID 'step-create-internet-gateway'.
--- Preparing to execute step: 'Attach Internet Gateway to VPC' (ID: step-attach-internet-gateway) ---
Executing tool 'attach-internet-gateway' with resolved params: {'internet_gateway_id': 'igw-057be1ccd756ac835', 'vpc_id': 'vpc-04f6ca5d65139bd59'}
Executing tool 'attach-internet-gateway' with params: {'internet_gateway_id': 'igw-057be1ccd756ac835', 'vpc_id': 'vpc-04f6ca5d65139bd59'}
Executing tool: attach-internet-gateway
Attaching Internet Gateway 'igw-057be1ccd756ac835' to VPC 'vpc-04f6ca5d65139bd59'.
Internet Gateway 'igw-057be1ccd756ac835' successfully attached to VPC 'vpc-04f6ca5d65139bd59'.
Tool 'attach-internet-gateway' executed successfully.
Step 'Attach Internet Gateway to VPC' completed. Result stored in context for ID 'step-attach-internet-gateway'.
--- Preparing to execute step: 'Create Public Subnet' (ID: step-create-public-subnet) ---
Executing tool 'create-public-subnet' with resolved params: {'vpc_id': 'vpc-04f6ca5d65139bd59', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-env-public-subnet-20251103193752'}
Executing tool 'create-public-subnet' with params: {'vpc_id': 'vpc-04f6ca5d65139bd59', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-env-public-subnet-20251103193752'}
Executing tool: create-public-subnet
Creating subnet with CIDR block '10.0.1.0/24' in VPC 'vpc-04f6ca5d65139bd59' (AZ: eu-west-2a).
Subnet created: subnet-084cf6b1e01a8ed2e
Modifying subnet 'subnet-084cf6b1e01a8ed2e' to set map_public_ip_on_launch to True.
Subnet 'subnet-084cf6b1e01a8ed2e' attribute modified successfully.
Tool 'create-public-subnet' executed successfully.
Step 'Create Public Subnet' completed. Result stored in context for ID 'step-create-public-subnet'.
--- Preparing to execute step: 'Create EC2 Key Pair 'test-key-03'' (ID: step-create-key-pair) ---
Executing tool 'create-key-pair' with resolved params: {'key_name': 'test-key-03'}
Executing tool 'create-key-pair' with params: {'key_name': 'test-key-03'}
Executing CreateKeyPairTool with key_name: test-key-03
Creating key pair: test-key-03
Tool 'create-key-pair' executed successfully.
Step 'Create EC2 Key Pair 'test-key-03'' completed. Result stored in context for ID 'step-create-key-pair'.
--- Preparing to execute step: 'Create Security Group 'web-sg'' (ID: step-create-security-group) ---
Executing tool 'create-security-group' with resolved params: {'group_name': 'web-sg-20251103193755', 'description': 'Allow SSH and HTTP access for web server', 'vpc_id': 'vpc-04f6ca5d65139bd59'}
Executing tool 'create-security-group' with params: {'group_name': 'web-sg-20251103193755', 'description': 'Allow SSH and HTTP access for web server', 'vpc_id': 'vpc-04f6ca5d65139bd59'}
Creating security group 'web-sg-20251103193755' in VPC 'vpc-04f6ca5d65139bd59'...
Security group 'web-sg-20251103193755' created with ID: sg-01129be5e1b260a0c
Security group 'web-sg-20251103193755' created with ID: sg-01129be5e1b260a0c
Tool 'create-security-group' executed successfully.
Step 'Create Security Group 'web-sg'' completed. Result stored in context for ID 'step-create-security-group'.
--- Preparing to execute step: 'Add SSH Ingress Rule to 'web-sg'' (ID: step-add-ssh-ingress-rule) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-01129be5e1b260a0c', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-01129be5e1b260a0c', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-01129be5e1b260a0c' for tcp:22-22 from 0.0.0.0/0...
Ingress rule added to security group 'sg-01129be5e1b260a0c'.
Ingress rule added to security group 'sg-01129be5e1b260a0c'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add SSH Ingress Rule to 'web-sg'' completed. Result stored in context for ID 'step-add-ssh-ingress-rule'.
--- Preparing to execute step: 'Add HTTP Ingress Rule to 'web-sg'' (ID: step-add-http-ingress-rule) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-01129be5e1b260a0c', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-01129be5e1b260a0c', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-01129be5e1b260a0c' for tcp:80-80 from 0.0.0.0/0...
Ingress rule added to security group 'sg-01129be5e1b260a0c'.
Ingress rule added to security group 'sg-01129be5e1b260a0c'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add HTTP Ingress Rule to 'web-sg'' completed. Result stored in context for ID 'step-add-http-ingress-rule'.
--- Preparing to execute step: 'Create EC2 Instance' (ID: step-create-ec2-instance) ---
Executing tool 'create-ec2-instance' with resolved params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-03', 'subnet_id': 'subnet-084cf6b1e01a8ed2e', 'security_group_ids': ['sg-01129be5e1b260a0c'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103193757'}]}
Executing tool 'create-ec2-instance' with params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-03', 'subnet_id': 'subnet-084cf6b1e01a8ed2e', 'security_group_ids': ['sg-01129be5e1b260a0c'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103193757'}]}
Executing tool: create-ec2-instance
Creating EC2 instance with image 'ami-0850ab57897dcaa32' and type 't3.micro'
Tool 'create-ec2-instance' executed successfully.
Step 'Create EC2 Instance' completed. Result stored in context for ID 'step-create-ec2-instance'.
Added/updated resource 'i-0fa803bb80116a639' to the state.
Saved new resource 'i-0fa803bb80116a639' of type 'aws_ec2_instance' to state.
--- Preparing to execute step: 'Create S3 Bucket for Logs' (ID: step-create-s3-bucket) ---
Executing tool 'create-s3-bucket' with resolved params: {'bucket_name': 'web-env-logs-20251103193758'}
Executing tool 'create-s3-bucket' with params: {'bucket_name': 'web-env-logs-20251103193758'}
Executing CreateS3BucketTool for bucket: web-env-logs-20251103193758
Attempting to create S3 bucket: web-env-logs-20251103193758
Using effective region for S3 bucket creation: eu-west-2
Creating S3 bucket: web-env-logs-20251103193758 in region: eu-west-2
Error creating S3 bucket 'web-env-logs-20251103193758': An error occurred (AccessDenied) when calling the CreateBucket operation: User: arn:aws:iam::782859940219:user/ai-agent-user is not authorized to perform: s3:CreateBucket on resource: "arn:aws:s3:::web-env-logs-20251103193758" because no identity-based policy allows the s3:CreateBucket action
Failed to create S3 bucket: An error occurred (AccessDenied) when calling the CreateBucket operation: User: arn:aws:iam::782859940219:user/ai-agent-user is not authorized to perform: s3:CreateBucket on resource: "arn:aws:s3:::web-env-logs-20251103193758" because no identity-based policy allows the s3:CreateBucket action
Tool 'create-s3-bucket' execution failed with error: An error occurred (AccessDenied) when calling the CreateBucket operation: User: arn:aws:iam::782859940219:user/ai-agent-user is not authorized to perform: s3:CreateBucket on resource: "arn:aws:s3:::web-env-logs-20251103193758" because no identity-based policy allows the s3:CreateBucket action
Execution failed at step 'Create S3 Bucket for Logs': Tool 'create-s3-bucket' execution failed: An error occurred (AccessDenied) when calling the CreateBucket operation: User: arn:aws:iam::782859940219:user/ai-agent-user is not authorized to perform: s3:CreateBucket on resource: "arn:aws:s3:::web-env-logs-20251103193758" because no identity-based policy allows the s3:CreateBucket action
An unexpected error occurred in the WebSocket handler: Tool 'create-s3-bucket' execution failed: An error occurred (AccessDenied) when calling the CreateBucket operation: User: arn:aws:iam::782859940219:user/ai-agent-user is not authorized to perform: s3:CreateBucket on resource: "arn:aws:s3:::web-env-logs-20251103193758" because no identity-based policy allows the s3:CreateBucket action
WebSocket connection closed.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-03'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 19 resources.
Set discovered state with 19 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-03'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-08574472bc1955da8
  Name: web-server-20251103191645
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-08574472bc1955da8, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:16:45+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:04 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:1bff7f03-1222-4fbb-ba81-a80ba3294855, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:16:45+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103191645}
- ID: i-0e38c183f664ecedb
  Name: web-server-20251103192713
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-0e38c183f664ecedb, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:27:14+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-26.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.26, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.171.165.34, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-01b235575503d2631, VpcId:vpc-0a55c84657c32d9ef, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-05c1eaaea0c9393aa'}}], ClientToken:53dead58-5746-493a-99e8-88000c24f3a0, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-09e688a63dfb51611', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], 'Ipv6Addresses': [], 'MacAddress': '06:8e:27:15:d9:2b', 'NetworkInterfaceId': 'eni-072c65cda8bef8c0b', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.26', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.26'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-01b235575503d2631', 'VpcId': 'vpc-0a55c84657c32d9ef', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:27:14+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192713}
- ID: i-00988ca268341bd1c
  Name: web-server-20251103192236
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-00988ca268341bd1c, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:22:37+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:37 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:ad01e547-9d30-4ca4-a8e7-c9eec690e830, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:22:37+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192236}
- ID: i-095e5af35d4722033
  Name: web-server-20251103193434
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-095e5af35d4722033, InstanceType:t3.micro, KeyName:test-key-02, LaunchTime:2025-11-03 19:34:35+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-207.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.207, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.130.105.106, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-0899c950c98523529, VpcId:vpc-0089d124f33a3f79f, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 34, 35, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-0b4ac4deed165f1dc'}}], ClientToken:b2614316-b669-43c1-b681-c0f4a8ede054, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.130.105.106'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 34, 35, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-00f7b69d1e764fdd9', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103193433', 'GroupId': 'sg-0aa99920e318585ea'}], 'Ipv6Addresses': [], 'MacAddress': '06:13:b0:e9:e1:f7', 'NetworkInterfaceId': 'eni-03826b9ba2393127b', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.207', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.130.105.106'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.207'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-0899c950c98523529', 'VpcId': 'vpc-0089d124f33a3f79f', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103193433', 'GroupId': 'sg-0aa99920e318585ea'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:34:35+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103193434}
- ID: i-0fa803bb80116a639
  Name: web-server-20251103193757
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-0fa803bb80116a639, InstanceType:t3.micro, KeyName:test-key-03, LaunchTime:2025-11-03 19:37:57+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-119.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.119, ProductCodes:[], PublicDnsName:, PublicIpAddress:3.9.180.24, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-084cf6b1e01a8ed2e, VpcId:vpc-04f6ca5d65139bd59, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 37, 58, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-03905196e895c1fa7'}}], ClientToken:1fbd79d9-25c3-4a8f-8737-b344b5227260, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '3.9.180.24'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 37, 57, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-06698bfc7298a5cce', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103193755', 'GroupId': 'sg-01129be5e1b260a0c'}], 'Ipv6Addresses': [], 'MacAddress': '06:09:be:01:b3:6f', 'NetworkInterfaceId': 'eni-0c39029e7a93d7604', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.119', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '3.9.180.24'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.119'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-084cf6b1e01a8ed2e', 'VpcId': 'vpc-04f6ca5d65139bd59', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103193755', 'GroupId': 'sg-01129be5e1b260a0c'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:37:57+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103193757}
- ID: vpc-0089d124f33a3f79f
  Name: vpc-0089d124f33a3f79f
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0089d124f33a3f79f, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-063e90ba075100090', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-02f1aa392704ff989
  Name: vpc-02f1aa392704ff989
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.10.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-02f1aa392704ff989, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0475cfecc66c03db1', 'CidrBlock': '10.10.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0a55c84657c32d9ef
  Name: vpc-0a55c84657c32d9ef
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0a55c84657c32d9ef, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c89a5d3fca263cf1', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-04f6ca5d65139bd59
  Name: vpc-04f6ca5d65139bd59
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-04f6ca5d65139bd59, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c5c660e23b9366b6', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-072f37b6be5080d20
  Name: vpc-072f37b6be5080d20
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-072f37b6be5080d20, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-075dd6d69422584c1', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: sg-0aa99920e318585ea
  Name: web-sg-20251103193433
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103193433, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0aa99920e318585ea, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0089d124f33a3f79f}
  Tags: {}
- ID: sg-0e77cfd3c5f50dc0b
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e77cfd3c5f50dc0b', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e77cfd3c5f50dc0b, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-02f1aa392704ff989}
  Tags: {}
- ID: sg-0b72528100fbe8490
  Name: web-sg-20251103193341
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103193341, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0b72528100fbe8490, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-072f37b6be5080d20}
  Tags: {}
- ID: sg-0c6dd4234ea8a4c8e
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0c6dd4234ea8a4c8e', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0c6dd4234ea8a4c8e, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0089d124f33a3f79f}
  Tags: {}
- ID: sg-01129be5e1b260a0c
  Name: web-sg-20251103193755
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103193755, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-01129be5e1b260a0c, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-04f6ca5d65139bd59}
  Tags: {}
- ID: sg-0691977ddfd2a2c0b
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0691977ddfd2a2c0b', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0691977ddfd2a2c0b, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-072f37b6be5080d20}
  Tags: {}
- ID: sg-068682835ed2b90e1
  Name: web-sg-20251103192710
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103192710, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-068682835ed2b90e1, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}
- ID: sg-0b7e0bc959563fa43
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0b7e0bc959563fa43', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0b7e0bc959563fa43, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-04f6ca5d65139bd59}
  Tags: {}
- ID: sg-0e94dd64535c0ef45
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e94dd64535c0ef45', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e94dd64535c0ef45, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'List Availability Zones' (ID: step-list-azs) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'List Availability Zones' completed. Result stored in context for ID 'step-list-azs'.
--- Preparing to execute step: 'Create new VPC' (ID: step-create-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.0.0.0/16', 'name': 'web-vpc-20251103194030'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.0.0.0/16', 'name': 'web-vpc-20251103194030'}
Executing CreateVpcTool with CIDR: 10.0.0.0/16
Creating VPC with CIDR block: 10.0.0.0/16
Error creating VPC: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
Failed to create VPC: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
Tool 'create-vpc' execution failed with error: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
Execution failed at step 'Create new VPC': Tool 'create-vpc' execution failed: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
An unexpected error occurred in the WebSocket handler: Tool 'create-vpc' execution failed: An error occurred (VpcLimitExceeded) when calling the CreateVpc operation: The maximum number of VPCs has been reached.
WebSocket connection closed.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-03'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 14 resources.
Set discovered state with 14 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-03'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-08574472bc1955da8
  Name: web-server-20251103191645
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-08574472bc1955da8, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:16:45+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:04 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:1bff7f03-1222-4fbb-ba81-a80ba3294855, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:16:45+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103191645}
- ID: i-0e38c183f664ecedb
  Name: web-server-20251103192713
  Type: aws_ec2_instance
  Status: shutting-down
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-0e38c183f664ecedb, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:27:14+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-26.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.26, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.171.165.34, State:{'Code': 32, 'Name': 'shutting-down'}, StateTransitionReason:User initiated (2025-11-03 19:41:35 GMT), SubnetId:subnet-01b235575503d2631, VpcId:vpc-0a55c84657c32d9ef, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-05c1eaaea0c9393aa'}}], ClientToken:53dead58-5746-493a-99e8-88000c24f3a0, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 27, 14, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-09e688a63dfb51611', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], 'Ipv6Addresses': [], 'MacAddress': '06:8e:27:15:d9:2b', 'NetworkInterfaceId': 'eni-072c65cda8bef8c0b', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.26', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.171.165.34'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.26'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-01b235575503d2631', 'VpcId': 'vpc-0a55c84657c32d9ef', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103192710', 'GroupId': 'sg-068682835ed2b90e1'}], SourceDestCheck:True, StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:27:14+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192713}
- ID: i-00988ca268341bd1c
  Name: web-server-20251103192236
  Type: aws_ec2_instance
  Status: terminated
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-00988ca268341bd1c, InstanceType:t3.micro, KeyName:test-key-01, LaunchTime:2025-11-03 19:22:37+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:, ProductCodes:[], PublicDnsName:, State:{'Code': 48, 'Name': 'terminated'}, StateTransitionReason:User initiated (2025-11-03 19:25:37 GMT), Architecture:x86_64, BlockDeviceMappings:[], ClientToken:ad01e547-9d30-4ca4-a8e7-c9eec690e830, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[], StateReason:{'Code': 'Client.UserInitiatedShutdown', 'Message': 'Client.UserInitiatedShutdown: User initiated shutdown'}, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'pending', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:22:37+00:00, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103192236}
- ID: i-095e5af35d4722033
  Name: web-server-20251103193434
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-095e5af35d4722033, InstanceType:t3.micro, KeyName:test-key-02, LaunchTime:2025-11-03 19:34:35+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-207.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.207, ProductCodes:[], PublicDnsName:, PublicIpAddress:18.130.105.106, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-0899c950c98523529, VpcId:vpc-0089d124f33a3f79f, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 34, 35, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-0b4ac4deed165f1dc'}}], ClientToken:b2614316-b669-43c1-b681-c0f4a8ede054, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.130.105.106'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 34, 35, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-00f7b69d1e764fdd9', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103193433', 'GroupId': 'sg-0aa99920e318585ea'}], 'Ipv6Addresses': [], 'MacAddress': '06:13:b0:e9:e1:f7', 'NetworkInterfaceId': 'eni-03826b9ba2393127b', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.207', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '18.130.105.106'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.207'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-0899c950c98523529', 'VpcId': 'vpc-0089d124f33a3f79f', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103193433', 'GroupId': 'sg-0aa99920e318585ea'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:34:35+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103193434}
- ID: i-0fa803bb80116a639
  Name: web-server-20251103193757
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0850ab57897dcaa32, InstanceId:i-0fa803bb80116a639, InstanceType:t3.micro, KeyName:test-key-03, LaunchTime:2025-11-03 19:37:57+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'eu-west-2a', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-10-0-1-119.eu-west-2.compute.internal, PrivateIpAddress:10.0.1.119, ProductCodes:[], PublicDnsName:, PublicIpAddress:3.9.180.24, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-084cf6b1e01a8ed2e, VpcId:vpc-04f6ca5d65139bd59, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 37, 58, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-03905196e895c1fa7'}}], ClientToken:1fbd79d9-25c3-4a8f-8737-b344b5227260, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '3.9.180.24'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 19, 37, 57, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-06698bfc7298a5cce', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'web-sg-20251103193755', 'GroupId': 'sg-01129be5e1b260a0c'}], 'Ipv6Addresses': [], 'MacAddress': '06:09:be:01:b3:6f', 'NetworkInterfaceId': 'eni-0c39029e7a93d7604', 'OwnerId': '782859940219', 'PrivateIpAddress': '10.0.1.119', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': '', 'PublicIp': '3.9.180.24'}, 'Primary': True, 'PrivateIpAddress': '10.0.1.119'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-084cf6b1e01a8ed2e', 'VpcId': 'vpc-04f6ca5d65139bd59', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'web-sg-20251103193755', 'GroupId': 'sg-01129be5e1b260a0c'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 19:37:57+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:web-server-20251103193757}
- ID: vpc-0089d124f33a3f79f
  Name: vpc-0089d124f33a3f79f
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0089d124f33a3f79f, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-063e90ba075100090', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-0a55c84657c32d9ef
  Name: vpc-0a55c84657c32d9ef
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-0a55c84657c32d9ef, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c89a5d3fca263cf1', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: vpc-04f6ca5d65139bd59
  Name: vpc-04f6ca5d65139bd59
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:10.0.0.0/16, DhcpOptionsId:dopt-0478c7065b27415bc, State:available, VpcId:vpc-04f6ca5d65139bd59, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-0c5c660e23b9366b6', 'CidrBlock': '10.0.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:False}
  Tags: {}
- ID: sg-0aa99920e318585ea
  Name: web-sg-20251103193433
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103193433, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-0aa99920e318585ea, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0089d124f33a3f79f}
  Tags: {}
- ID: sg-0c6dd4234ea8a4c8e
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0c6dd4234ea8a4c8e', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0c6dd4234ea8a4c8e, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0089d124f33a3f79f}
  Tags: {}
- ID: sg-01129be5e1b260a0c
  Name: web-sg-20251103193755
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103193755, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-01129be5e1b260a0c, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-04f6ca5d65139bd59}
  Tags: {}
- ID: sg-068682835ed2b90e1
  Name: web-sg-20251103192710
  Type: aws_security_group
  Status: available
  Properties: {Description:Allow SSH and HTTP access for web server, GroupName:web-sg-20251103192710, IpPermissions:[{'FromPort': 80, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 80, 'UserIdGroupPairs': []}, {'FromPort': 22, 'IpProtocol': 'tcp', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'ToPort': 22, 'UserIdGroupPairs': []}], OwnerId:782859940219, GroupId:sg-068682835ed2b90e1, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}
- ID: sg-0b7e0bc959563fa43
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0b7e0bc959563fa43', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0b7e0bc959563fa43, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-04f6ca5d65139bd59}
  Tags: {}
- ID: sg-0e94dd64535c0ef45
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0e94dd64535c0ef45', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0e94dd64535c0ef45, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0a55c84657c32d9ef}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'List Availability Zones' (ID: step-list-azs) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'List Availability Zones' completed. Result stored in context for ID 'step-list-azs'.
--- Preparing to execute step: 'Create new VPC' (ID: step-create-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.0.0.0/16', 'name': 'web-vpc-20251103194240'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.0.0.0/16', 'name': 'web-vpc-20251103194240'}
Executing CreateVpcTool with CIDR: 10.0.0.0/16
Creating VPC with CIDR block: 10.0.0.0/16
VPC created: vpc-0dd4734789252c83c
Tool 'create-vpc' executed successfully.
Step 'Create new VPC' completed. Result stored in context for ID 'step-create-vpc'.
--- Preparing to execute step: 'Create Internet Gateway' (ID: step-create-igw) ---
Executing tool 'create-internet-gateway' with resolved params: {'name': 'web-igw-20251103194242'}
Executing tool 'create-internet-gateway' with params: {'name': 'web-igw-20251103194242'}
Executing tool: create-internet-gateway
Creating Internet Gateway.
Internet Gateway created: igw-064350ad068d9c800
Tool 'create-internet-gateway' executed successfully.
Step 'Create Internet Gateway' completed. Result stored in context for ID 'step-create-igw'.
--- Preparing to execute step: 'Attach Internet Gateway to VPC' (ID: step-attach-igw) ---
Executing tool 'attach-internet-gateway' with resolved params: {'vpc_id': 'vpc-0dd4734789252c83c', 'internet_gateway_id': 'igw-064350ad068d9c800'}
Executing tool 'attach-internet-gateway' with params: {'vpc_id': 'vpc-0dd4734789252c83c', 'internet_gateway_id': 'igw-064350ad068d9c800'}
Executing tool: attach-internet-gateway
Attaching Internet Gateway 'igw-064350ad068d9c800' to VPC 'vpc-0dd4734789252c83c'.
Internet Gateway 'igw-064350ad068d9c800' successfully attached to VPC 'vpc-0dd4734789252c83c'.
Tool 'attach-internet-gateway' executed successfully.
Step 'Attach Internet Gateway to VPC' completed. Result stored in context for ID 'step-attach-igw'.
--- Preparing to execute step: 'Create Public Subnet' (ID: step-create-public-subnet) ---
Executing tool 'create-public-subnet' with resolved params: {'vpc_id': 'vpc-0dd4734789252c83c', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-public-subnet-20251103194243'}
Executing tool 'create-public-subnet' with params: {'vpc_id': 'vpc-0dd4734789252c83c', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-public-subnet-20251103194243'}
Executing tool: create-public-subnet
Creating subnet with CIDR block '10.0.1.0/24' in VPC 'vpc-0dd4734789252c83c' (AZ: eu-west-2a).
Subnet created: subnet-04ba9e3ecd400ea18
Modifying subnet 'subnet-04ba9e3ecd400ea18' to set map_public_ip_on_launch to True.
Subnet 'subnet-04ba9e3ecd400ea18' attribute modified successfully.
Tool 'create-public-subnet' executed successfully.
Step 'Create Public Subnet' completed. Result stored in context for ID 'step-create-public-subnet'.
--- Preparing to execute step: 'Create EC2 Key Pair 'test-key-03'' (ID: step-create-key-pair) ---
Executing tool 'create-key-pair' with resolved params: {'key_name': 'test-key-03'}
Executing tool 'create-key-pair' with params: {'key_name': 'test-key-03'}
Executing CreateKeyPairTool with key_name: test-key-03
Creating key pair: test-key-03
Error creating key pair 'test-key-03': An error occurred (InvalidKeyPair.Duplicate) when calling the CreateKeyPair operation: The keypair already exists
Execution failed at step 'Create EC2 Key Pair 'test-key-03'': An error occurred (InvalidKeyPair.Duplicate) when calling the CreateKeyPair operation: The keypair already exists
An unexpected error occurred in the WebSocket handler: An error occurred (InvalidKeyPair.Duplicate) when calling the CreateKeyPair operation: The keypair already exists
WebSocket connection closed.
Initializing StateAwareAgent singleton...
Initializing StateManager singleton...
Initializing ToolFactory singleton...
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
ToolFactory initialized with 27 tools.
Initializing DiscoveryScanner singleton...
LLM Provider configured: gemini
LLM Model configured: gemini-2.5-flash
ToolFactory initialized. Registering tools...
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'rds' in region 'eu-west-2'
Successfully created boto3 client for 'rds'.
Creating boto3 client for service 'ec2' in region 'eu-west-2'
Successfully created boto3 client for 'ec2'.
Creating boto3 client for service 'elbv2' in region 'eu-west-2'
Successfully created boto3 client for 'elbv2'.
Creating boto3 client for service 's3' in region 'eu-west-2'
Successfully created boto3 client for 's3'.
Registering tool: create-ec2-instance
Registering tool: list-ec2-instances
Registering tool: terminate-ec2-instance
Registering tool: start-ec2-instance
Registering tool: stop-ec2-instance
Registering tool: create-volume
Registering tool: list-availability-zones
Registering tool: get-latest-amazon-linux-ami
Registering tool: get-latest-ubuntu-ami
Registering tool: create-key-pair
Registering tool: list-key-pairs
Registering tool: get-default-vpc
Registering tool: list-subnets
Registering tool: list-vpcs
Registering tool: create-vpc
Registering tool: list-subnets-for-alb
Registering tool: create-internet-gateway
Registering tool: attach-internet-gateway
Registering tool: create-public-subnet
Registering tool: list-db-instances
Registering tool: create-db-subnet-group
Registering tool: create-db-instance
Registering tool: create-security-group
Registering tool: add-security-group-ingress-rule
Registering tool: list-security-groups
Registering tool: create-load-balancer
Registering tool: create-s3-bucket
Registered 27 tools.
StateAwareAgent initialized.
Processing request: 'Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-04'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.'
Triggering automatic AWS resource discovery before processing request...
Starting AWS resource discovery...
Finished AWS resource discovery. Found 16 resources.
Set discovered state with 16 resources.
Automatic AWS resource discovery completed.
ğŸ¯ AWS INFRASTRUCTURE AUTOMATION AGENT

You are an expert AWS infrastructure automation agent. Generate executable infrastructure plans using available Tools and current infrastructure state.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
USER REQUEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Táº¡o má»™t mÃ´i trÆ°á»ng web hoÃ n chá»‰nh: Äáº§u tiÃªn, táº¡o má»™t VPC má»›i. Sau Ä‘Ã³, táº¡o má»™t key pair tÃªn lÃ  'test-key-04'. Tiáº¿p theo, táº¡o má»™t security group tÃªn 'web-sg' cho phÃ©p truy cáº­p SSH vÃ  HTTP. Sá»­ dá»¥ng AMI Ubuntu má»›i nháº¥t Ä‘á»ƒ táº¡o má»™t EC2 instance trong VPC Ä‘Ã³ vá»›i key pair vá»«a táº¡o. Cuá»‘i cÃ¹ng, táº¡o má»™t S3 bucket cÃ³ tÃªn ngáº«u nhiÃªn vÃ  duy nháº¥t Ä‘á»ƒ lÆ°u trá»¯ logs.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
AVAILABLE TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ MCP TOOLS & EXECUTION CONTEXT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š AVAILABLE MCP TOOLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[
  {
    "name": "create-ec2-instance",
    "description": "Creates a new EC2 instance."
  },
  {
    "name": "list-ec2-instances",
    "description": "Lists existing EC2 instances."
  },
  {
    "name": "terminate-ec2-instance",
    "description": "Terminates a specific EC2 instance."
  },
  {
    "name": "start-instance",
    "description": "Starts a specified EC2 instance."
  },
  {
    "name": "stop-instance",
    "description": "Stops a specified EC2 instance."
  },
  {
    "name": "create-volume",
    "description": "Creates a new EBS volume in a specified Availability Zone."
  },
  {
    "name": "list-availability-zones",
    "description": "Lists all available AWS Availability Zones in the current region."
  },
  {
    "name": "get-latest-amazon-linux-ami",
    "description": "Find the latest Amazon Linux 2 AMI ID to use for launching EC2 instances."
  },
  {
    "name": "get-latest-ubuntu-ami",
    "description": "Find the latest Ubuntu AMI ID to use for launching EC2 instances."
  },
  {
    "name": "create-key-pair",
    "description": "Create a new EC2 key pair for SSH access. Returns the private key material which should be saved immediately as it cannot be retrieved later."
  },
  {
    "name": "list-key-pairs",
    "description": "List all existing EC2 key pairs in the configured region."
  },
  {
    "name": "get-default-vpc",
    "description": "Finds the ID of the default VPC in the configured region."
  },
  {
    "name": "list-subnets",
    "description": "Lists subnets in a specified VPC."
  },
  {
    "name": "list-vpcs",
    "description": "Lists all VPCs in the configured region."
  },
  {
    "name": "create-vpc",
    "description": "Creates a new VPC with a specified CIDR block."
  },
  {
    "name": "list-subnets-for-alb",
    "description": "Selects at least two subnets from different Availability Zones within a VPC, suitable for a high-availability Application Load Balancer."
  },
  {
    "name": "create-internet-gateway",
    "description": "Creates a new Internet Gateway for a VPC."
  },
  {
    "name": "attach-internet-gateway",
    "description": "Attaches an existing Internet Gateway to a specified VPC."
  },
  {
    "name": "create-public-subnet",
    "description": "Creates a new public subnet in a VPC and enables auto-assign public IP."
  },
  {
    "name": "list-rds-instances",
    "description": "Lists all RDS database instances or a specific instance if an identifier is provided."
  },
  {
    "name": "create-db-subnet-group",
    "description": "Creates a new DB Subnet Group for RDS instances."
  },
  {
    "name": "create-db-instance",
    "description": "Creates a new RDS database instance."
  },
  {
    "name": "create-security-group",
    "description": "Creates a new EC2 security group in a specified VPC."
  },
  {
    "name": "add-security-group-ingress-rule",
    "description": "Adds an ingress rule to an existing EC2 security group."
  },
  {
    "name": "list-security-groups",
    "description": "Lists all EC2 security groups, optionally filtered by a list of group IDs."
  },
  {
    "name": "create-load-balancer",
    "description": "Creates a new Application or Network Load Balancer."
  },
  {
    "name": "create-s3-bucket",
    "description": "Creates a new S3 bucket in a specified region."
  }
]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” QUERY ACTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Use "query" action to discover existing AWS resources dynamically.
These steps MUST be placed FIRST in your execution plan.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ TOOL PATTERN REFERENCE FOR NEW RESOURCES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you encounter a resource not explicitly documented below, follow these patterns:

TOOL NAMING PATTERNS:
â”œâ”€ Discovery: get-default-{{resource}}, list-{{resources}}, get-latest-{{type}}
â”œâ”€ Creation: create-{{resource}}
â””â”€ Management: start-{{resource}}, stop-{{resource}}, delete-{{resource}}

PARAMETER STYLE:
â”œâ”€ Always snake_case: vpc_id, bucket_name, function_name (NOT vpcId, bucketName)
â”œâ”€ No filters in list tools: list-vpcs, list-subnets (NOT list-vpcs with filters)
â””â”€ Arrays when multiple: subnet_ids, security_group_ids

OUTPUT FIELDS (from tool execution):
â”œâ”€ IDs: {{resource}}_id â†’ vpc_id, subnet_id, instance_id
â”œâ”€ ARNs: {{resource}}_arn â†’ role_arn, function_arn, topic_arn
â””â”€ Names: {{resource}}_name â†’ bucket_name, table_name

COMMON PATTERNS BY CATEGORY:

Storage (S3, EFS, EBS):
  Tools: create-s3-bucket, create-file-system, create-volume
  Params: bucket_name, file_system_name, volume_id, size
  No network dependencies

Compute (EC2, Lambda, ECS):
  Tools: create-ec2-instance, create-lambda-function, create-ecs-cluster
  Params: image_id/function_name, instance_type/runtime, vpc_id, subnet_id, security_group_id
  Requires: VPC, Subnet, Security Group

Database (RDS, DynamoDB):
  Tools: create-db-instance, create-table
  Params: db_instance_identifier/table_name, engine/attributes, vpc_id, subnet_ids
  Requires: VPC, Subnets (multiple AZs), Security Group, DB subnet group

Network (ALB, VPC, CloudFront):
  Tools: create-load-balancer, create-vpc, create-distribution
  Params: name, scheme, vpc_id, subnet_ids, security_group_ids
  Requires: VPC, Subnets (2+ AZs for ALB)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ DOCUMENTED RESOURCE PATTERNS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Below are specific patterns for commonly used resources. For resources not listed,
apply the general patterns above.

PATTERN 1: VPC DISCOVERY
Discover existing VPCs or get default VPC

METHOD A: Get default VPC (recommended):
{
  "id": "step-discover-vpc",
  "name": "Get default VPC",
  "description": "Find default VPC for resource placement",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "get-default-vpc",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

METHOD B: List all VPCs:
{
  "id": "step-discover-vpc",
  "name": "List VPCs",
  "description": "Find all VPCs in region",
  "action": "query",
  "resourceId": "vpc",
  "mcpTool": "list-vpcs",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns vpc_id field

PATTERN 2: SUBNET DISCOVERY
Discover subnets within a VPC

METHOD A: List subnets in VPC:
{
  "id": "step-discover-subnets",
  "name": "List subnets",
  "description": "Find all subnets in VPC",
  "action": "query",
  "resourceId": "subnets",
  "mcpTool": "list-subnets",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

METHOD B: Select subnets for ALB (auto-selects 2+ subnets in different AZs):
{
  "id": "step-select-alb-subnets",
  "name": "Select subnets for ALB",
  "description": "Auto-select subnets for load balancer",
  "action": "query",
  "resourceId": "alb-subnets",
  "mcpTool": "list-subnets-for-alb",
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "min_azs": 2,
    "require_multi_az": true
  },
  "dependsOn": ["step-discover-vpc"],
  "status": "pending"
}

Output: Returns subnetId field or array of subnet IDs
Note: For single subnet needs, use list-subnets and select first result
Note: For ALB deployments, always use list-subnets-for-alb to ensure multi-AZ compliance

PATTERN 3: SECURITY GROUP DISCOVERY
Discover security groups in a VPC

METHOD A: List all security groups:
{
  "id": "step-discover-sg",
  "name": "List security groups",
  "description": "Find available security groups",
  "action": "query",
  "resourceId": "security-group",
  "mcpTool": "list-security-groups",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns securityGroupId field

Common filters:
- "vpc-id": "vpc-xxxxx" â†’ Find SGs in VPC
- "group-name": "web-sg" â†’ Find by name
- "tag:Environment": "production" â†’ Find by tag

PATTERN 4: AMI DISCOVERY
Discover latest AMI for instance launch

METHOD A: Get latest Ubuntu AMI:
{
  "id": "step-get-ubuntu-ami",
  "name": "Get latest Ubuntu AMI",
  "description": "Find latest Ubuntu image",
  "action": "query",
  "resourceId": "ubuntu-ami",
  "mcpTool": "get-latest-ubuntu-ami",
  "toolParameters": {
    "architecture": "x86_64"
  },
  "dependsOn": [],
  "status": "pending"
}

Output: Returns imageId field

PATTERN 5: INSTANCE DISCOVERY
Discover existing EC2 instances

{
  "id": "step-list-instances",
  "name": "List EC2 instances",
  "description": "Find running EC2 instances",
  "action": "query",
  "resourceId": "instances",
  "mcpTool": "list-ec2-instances",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns instanceId field

PATTERN 6: AVAILABILITY ZONE DISCOVERY
Discover available Availability Zones

{
  "id": "step-list-azs",
  "name": "List Availability Zones",
  "description": "Find all available Availability Zones in the current region.",
  "action": "query",
  "resourceId": "availability-zones",
  "mcpTool": "list-availability-zones",
  "toolParameters": {},
  "dependsOn": [],
  "status": "pending"
}

Output: Returns an array of strings (e.g., ["us-east-1a", "us-east-1b"])
Reference: {{step-list-azs.availability_zones[0]}} for the first AZ.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PARAMETER RESOLUTION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SINGLE VALUE REFERENCE:
When a tool requires a single resource ID, reference the discovery step output:

{
  "toolParameters": {
    "vpc_id": "{{step-discover-vpc.vpc_id}}",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "image_id": "{{step-discover-ami.imageId}}"
  }
}

ARRAY VALUE REFERENCE:
When a tool accepts multiple IDs (subnets, security groups):

{
  "toolParameters": {
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": [
      "{{step-discover-sg.securityGroupId}}"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ COMMON RESOURCE CREATION PATTERNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PATTERN 1: EC2 INSTANCE
Requires: AMI, VPC, Subnet, Security Group, Key Pair

Discovery Phase (steps 1-4):
- Discover VPC
- Discover Subnet
- Discover AMI
- Discover Security Group

Creation Phase (step 5):
{
  "action": "create",
  "mcpTool": "create-ec2-instance",
  "toolParameters": {
    "image_id": "{{step-discover-ami.imageId}}",
    "instance_type": "t3.micro", // Prioritize use t3.micro
    "key_name": "your-key-pair-name",
    "subnet_id": "{{step-discover-subnet.subnetId}}",
    "security_group_ids": ["{{step-discover-sg.securityGroupId}}"],
    "tags": [{"Key": "Name", "Value": "web-server"}]
  },
  "dependsOn": ["step-discover-ami", "step-discover-subnet", "step-discover-sg"]
}

PATTERN 2: SECURITY GROUP WITH RULES
Create security group, then add rules

Step 1 - Create Security Group:
{
  "action": "create",
  "mcpTool": "create-security-group",
  "toolParameters": {
    "group_name": "web-sg",
    "description": "Allow web traffic",
    "vpc_id": "{{step-discover-vpc.vpc_id}}"
  },
  "dependsOn": ["step-discover-vpc"]
}

Step 2 - Add Ingress Rules:
{
  "action": "create",
  "mcpTool": "add-security-group-ingress-rule",
  "toolParameters": {
    "group_id": "{{step-create-sg.groupId}}",
    "protocol": "tcp",
    "from_port": 80,
    "to_port": 80,
    "cidr_block": "0.0.0.0/0"
  },
  "dependsOn": ["step-create-sg"]
}

PATTERN 3: APPLICATION LOAD BALANCER
Requires: VPC, Subnets (2+ in different AZs), Security Group, Target Group

Load Balancer Creation:
{
  "action": "create",
  "mcpTool": "create-load-balancer",
  "toolParameters": {
    "name": "web-alb",
    "type": "application",
    "scheme": "internet-facing",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ],
    "security_group_ids": ["{{step-create-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2", "step-create-sg"]
}

PATTERN 4: RDS DATABASE
Requires: VPC, Subnets (2+ in different AZs), DB Subnet Group, Security Group

DB Subnet Group Creation:
{
  "action": "create",
  "mcpTool": "create-db-subnet-group",
  "toolParameters": {
    "db_subnet_group_name": "db-subnet-group",
    "db_subnet_group_description": "Subnet group for RDS",
    "subnet_ids": [
      "{{step-discover-subnet-1.subnetId}}",
      "{{step-discover-subnet-2.subnetId}}"
    ]
  },
  "dependsOn": ["step-discover-subnet-1", "step-discover-subnet-2"]
}

RDS Instance Creation:
{
  "action": "create",
  "mcpTool": "create-db-instance",
  "toolParameters": {
    "db_instance_identifier": "mysql-db",
    "db_instance_class": "db.t3.micro",
    "engine": "mysql",
    "engine_version": "8.0",
    "master_username": "admin",
    "master_user_password": "SecurePass123!",
    "allocated_storage": 20,
    "db_subnet_group_name": "{{step-create-db-subnet-group.dbSubnetGroupName}}",
    "vpc_security_group_ids": ["{{step-create-db-sg.securityGroupId}}"]
  },
  "dependsOn": ["step-create-db-subnet-group", "step-create-db-sg"]
}

PATTERN 5: PUBLIC SUBNET CREATION
Requires: VPC, CIDR Block, Availability Zone

{
  "action": "create",
  "mcpTool": "create-public-subnet",
  "toolParameters": {
    "vpc_id": "{{step-create-vpc.vpc_id}}",
    "cidr_block": "10.0.1.0/24", // Example CIDR
    "availability_zone": "{{step-list-azs.availability_zones[0]}}",
    "name": "public-subnet-{timestamp}"
  },
  "dependsOn": ["step-create-vpc", "step-list-azs"]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL REMINDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ALL query steps MUST be placed FIRST in execution plan
2. Discovery steps have NO dependencies (dependsOn: [])
3. Only reference previous steps in the execution order
4. Use exact field names from tool output schemas
5. For multi-value parameters, always use arrays
6. Include ALL referenced steps in dependsOn array
7. Use only "create" and "query" actions

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ—ï¸ MANAGED RESOURCES (CURRENT STATE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ID: i-0c38efd7b796c10d7
  Name: new-ec2-instance-20251103184635
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0bde73fd629657a59, InstanceId:i-0c38efd7b796c10d7, InstanceType:t3.micro, KeyName:ec2-instance-key-20251103184633, LaunchTime:2025-11-03 18:46:36+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'sa-east-1b', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-172-31-30-168.sa-east-1.compute.internal, PrivateIpAddress:172.31.30.168, ProductCodes:[], PublicDnsName:ec2-15-228-219-180.sa-east-1.compute.amazonaws.com, PublicIpAddress:15.228.219.180, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-007a2aca7a6c9a0c7, VpcId:vpc-0054bcca2ef516ccc, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 18, 46, 37, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-01fa6488fd69f49bc'}}], ClientToken:2a25d153-59ba-405b-a2b2-f7435206ee78, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': 'ec2-15-228-219-180.sa-east-1.compute.amazonaws.com', 'PublicIp': '15.228.219.180'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 18, 46, 36, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-0766506bb76e8421b', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'default', 'GroupId': 'sg-0047e87d8873212da'}], 'Ipv6Addresses': [], 'MacAddress': '06:52:f0:5a:62:db', 'NetworkInterfaceId': 'eni-0ce323d33033a9943', 'OwnerId': '782859940219', 'PrivateDnsName': 'ip-172-31-30-168.sa-east-1.compute.internal', 'PrivateIpAddress': '172.31.30.168', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': 'ec2-15-228-219-180.sa-east-1.compute.amazonaws.com', 'PublicIp': '15.228.219.180'}, 'Primary': True, 'PrivateDnsName': 'ip-172-31-30-168.sa-east-1.compute.internal', 'PrivateIpAddress': '172.31.30.168'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-007a2aca7a6c9a0c7', 'VpcId': 'vpc-0054bcca2ef516ccc', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'default', 'GroupId': 'sg-0047e87d8873212da'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 18:46:36+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:new-ec2-instance-20251103184635}
- ID: i-0dad43f51189d422b
  Name: new-ec2-instance-20251103184654
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0bde73fd629657a59, InstanceId:i-0dad43f51189d422b, InstanceType:t3.micro, KeyName:ec2-instance-key-20251103184653, LaunchTime:2025-11-03 18:46:55+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'sa-east-1b', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-172-31-21-139.sa-east-1.compute.internal, PrivateIpAddress:172.31.21.139, ProductCodes:[], PublicDnsName:ec2-56-125-92-136.sa-east-1.compute.amazonaws.com, PublicIpAddress:56.125.92.136, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-007a2aca7a6c9a0c7, VpcId:vpc-0054bcca2ef516ccc, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 18, 46, 56, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-01d92c84b3abed366'}}], ClientToken:b56199d6-0ecd-4587-a5ae-a7074ff6439e, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': 'ec2-56-125-92-136.sa-east-1.compute.amazonaws.com', 'PublicIp': '56.125.92.136'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 18, 46, 55, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-00ac0ee2af6fc43db', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'default', 'GroupId': 'sg-0047e87d8873212da'}], 'Ipv6Addresses': [], 'MacAddress': '06:32:ff:6f:0b:81', 'NetworkInterfaceId': 'eni-0c965df269f58a2f4', 'OwnerId': '782859940219', 'PrivateDnsName': 'ip-172-31-21-139.sa-east-1.compute.internal', 'PrivateIpAddress': '172.31.21.139', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': 'ec2-56-125-92-136.sa-east-1.compute.amazonaws.com', 'PublicIp': '56.125.92.136'}, 'Primary': True, 'PrivateDnsName': 'ip-172-31-21-139.sa-east-1.compute.internal', 'PrivateIpAddress': '172.31.21.139'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-007a2aca7a6c9a0c7', 'VpcId': 'vpc-0054bcca2ef516ccc', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'default', 'GroupId': 'sg-0047e87d8873212da'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 18:46:55+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:new-ec2-instance-20251103184654}
- ID: i-00d8ea51011eb1fe1
  Name: new-ec2-instance-20251103185020
  Type: aws_ec2_instance
  Status: running
  Properties: {AmiLaunchIndex:0, ImageId:ami-0bde73fd629657a59, InstanceId:i-00d8ea51011eb1fe1, InstanceType:t3.micro, KeyName:ec2-instance-key-20251103185016, LaunchTime:2025-11-03 18:50:21+00:00, Monitoring:{'State': 'disabled'}, Placement:{'AvailabilityZone': 'sa-east-1b', 'GroupName': '', 'Tenancy': 'default'}, PrivateDnsName:ip-172-31-31-254.sa-east-1.compute.internal, PrivateIpAddress:172.31.31.254, ProductCodes:[], PublicDnsName:ec2-54-207-148-236.sa-east-1.compute.amazonaws.com, PublicIpAddress:54.207.148.236, State:{'Code': 16, 'Name': 'running'}, StateTransitionReason:, SubnetId:subnet-007a2aca7a6c9a0c7, VpcId:vpc-0054bcca2ef516ccc, Architecture:x86_64, BlockDeviceMappings:[{'DeviceName': '/dev/sda1', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 3, 18, 50, 22, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-04e3c8b7149449a10'}}], ClientToken:8b665c5e-1863-4c8b-9206-4a2fc61f8c41, EbsOptimized:False, EnaSupport:True, Hypervisor:xen, NetworkInterfaces:[{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': 'ec2-54-207-148-236.sa-east-1.compute.amazonaws.com', 'PublicIp': '54.207.148.236'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 3, 18, 50, 21, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-005a011cfe8caee91', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'default', 'GroupId': 'sg-0047e87d8873212da'}], 'Ipv6Addresses': [], 'MacAddress': '06:21:27:1e:c3:5d', 'NetworkInterfaceId': 'eni-07b768b9d8760c27b', 'OwnerId': '782859940219', 'PrivateDnsName': 'ip-172-31-31-254.sa-east-1.compute.internal', 'PrivateIpAddress': '172.31.31.254', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': 'ec2-54-207-148-236.sa-east-1.compute.amazonaws.com', 'PublicIp': '54.207.148.236'}, 'Primary': True, 'PrivateDnsName': 'ip-172-31-31-254.sa-east-1.compute.internal', 'PrivateIpAddress': '172.31.31.254'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-007a2aca7a6c9a0c7', 'VpcId': 'vpc-0054bcca2ef516ccc', 'InterfaceType': 'interface'}], RootDeviceName:/dev/sda1, RootDeviceType:ebs, SecurityGroups:[{'GroupName': 'default', 'GroupId': 'sg-0047e87d8873212da'}], SourceDestCheck:True, VirtualizationType:hvm, CpuOptions:{'CoreCount': 1, 'ThreadsPerCore': 2}, CapacityReservationSpecification:{'CapacityReservationPreference': 'open'}, HibernationOptions:{'Configured': False}, MetadataOptions:{'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, EnclaveOptions:{'Enabled': False}, BootMode:uefi-preferred, PlatformDetails:Linux/UNIX, UsageOperation:RunInstances, UsageOperationUpdateTime:2025-11-03 18:50:21+00:00, PrivateDnsNameOptions:{'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, MaintenanceOptions:{'AutoRecovery': 'default'}, CurrentInstanceBootMode:uefi}
  Tags: {Name:new-ec2-instance-20251103185020}
- ID: vpc-0054bcca2ef516ccc
  Name: vpc-0054bcca2ef516ccc
  Type: aws_vpc
  Status: available
  Properties: {CidrBlock:172.31.0.0/16, DhcpOptionsId:dopt-0c7273ae4ab6b762e, State:available, VpcId:vpc-0054bcca2ef516ccc, OwnerId:782859940219, InstanceTenancy:default, CidrBlockAssociationSet:[{'AssociationId': 'vpc-cidr-assoc-06fc4675b8c7ab62e', 'CidrBlock': '172.31.0.0/16', 'CidrBlockState': {'State': 'associated'}}], IsDefault:True}
  Tags: {}
- ID: sg-0047e87d8873212da
  Name: default
  Type: aws_security_group
  Status: available
  Properties: {Description:default VPC security group, GroupName:default, IpPermissions:[{'IpProtocol': '-1', 'IpRanges': [], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': [{'GroupId': 'sg-0047e87d8873212da', 'UserId': '782859940219'}]}], OwnerId:782859940219, GroupId:sg-0047e87d8873212da, IpPermissionsEgress:[{'IpProtocol': '-1', 'IpRanges': [{'CidrIp': '0.0.0.0/0'}], 'Ipv6Ranges': [], 'PrefixListIds': [], 'UserIdGroupPairs': []}], VpcId:vpc-0054bcca2ef516ccc}
  Tags: {}


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âš ï¸ CRITICAL: STATE-AWARE RESOURCE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Check if "ğŸ—ï¸ MANAGED RESOURCES" section exists in the context above.

IF MANAGED RESOURCES section exists:
  â†’ Check if needed resource is listed
  â†’ If YES: Extract [property:value] â†’ Use directly â†’ NO discovery step
  â†’ If NO: Proceed with discovery or creation as needed

IF MANAGED RESOURCES section does NOT exist or is empty:
  â†’ State is empty (fresh start)
  â†’ All resources need discovery (for existing AWS resources) or creation (for new resources)
  â†’ Proceed normally with query and create actions

Example (when MANAGED resources exist):
Managed: "- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]"
âœ… Use: "vpc_id": "vpc-04aea" (literal value, no dependency)
âŒ Don't: Create step-discover-vpc with list-vpcs tool

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ACTIONS & STATE EXTRACTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALLOWED ACTIONS:
â€¢ "create" - Create AWS resources
â€¢ "query" - Discover resources NOT in MANAGED section (e.g., AMI lookup, subnet listing)

FORBIDDEN: update, delete, validate, observe, or query for MANAGED resources

STATE EXTRACTION PATTERN (applies to ALL resource types):
Format: "- <name> (<type>): <status> [<property>:<value>, ...]"
Process: Find type in MANAGED â†’ Parse [property:value] â†’ Extract value â†’ Use as literal

Common Properties (for state extraction):
vpcâ†’vpc_id, subnetâ†’subnet_id, security_groupâ†’group_id, ec2_instanceâ†’instance_id,
rds_instanceâ†’db_instance_identifier, lambda_functionâ†’function_arn, s3_bucketâ†’bucket_name,
load_balancerâ†’load_balancer_arn, target_groupâ†’target_group_arn, iam_roleâ†’role_arn

Universal Rule: For ANY resource type, extract primary identifier from [property:value]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”‘ EXECUTION RULES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VALUE TYPES:
   â€¢ Managed Resource Values: Extract from state [prop:val] â†’ Use literal â†’ NO dependsOn
   â€¢ Step Output Values: Reference as {step-id.field} â†’ Add step-id to dependsOn

2. ORDERING:
   â€¢ ALL query steps FIRST
   â€¢ Create steps AFTER their dependencies
   â€¢ Foundation â†’ Network â†’ Security â†’ Compute â†’ Configuration

3. PARAMETER NAMING:
   â€¢ Always snake_case: vpc_id, subnet_id, security_group_ids, instance_type, db_instance_identifier, key_name
   â€¢ Never camelCase: vpcId, subnetId, securityGroupIds, keyPairName

4. UNIQUENESS:
   â€¢ To avoid naming conflicts, resource names SHOULD be made unique.
   â€¢ Append a timestamp placeholder to names. Example: "key_name": "my-app-key-{timestamp}", "group_name": "my-app-sg-{timestamp}".

5. SCHEMA ADHERENCE (CRITICAL):
   â€¢ Tool parameter names MUST EXACTLY match the names in the tool's 'Input Schema'.
   â€¢ DO NOT invent or use alternative names (e.g., use 'protocol', not 'ip_protocol'; use 'cidr_block', not 'cidr_ip').

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TOOL NAMING CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Discovery: get-default-{resource}, list-{resources}, get-latest-{type}, select-{resources}-for-{purpose}
Creation: create-{resource}
Management: start-{resource}, stop-{resource}

Examples: get-default-vpc, list-subnets, get-latest-ubuntu-ami, list-subnets-for-alb, create-ec2-instance

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  DEPENDENCY ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

UNIVERSAL DEPENDENCY PRINCIPLES:
1. Check MANAGED RESOURCES first (use directly if exists)
2. Foundation Layer: VPC, Regions, Availability Zones
3. Network Layer: Subnets, Internet Gateways, NAT Gateways, Route Tables, Transit Gateways
4. Security Layer: Security Groups, NACLs, IAM Roles/Policies, KMS Keys
5. Resource Groups: DB Subnet Groups, Cache Subnet Groups, ECS Clusters, EKS Clusters
6. Primary Resources: EC2, Lambda, RDS, S3, ECS Services, EKS Nodes, SageMaker, etc.
7. Configuration Layer: Load Balancer Listeners, Target Groups, Auto Scaling Policies, CloudWatch Alarms

DEPENDENCY PATTERNS (apply to ANY resource type):
â€¢ Network-attached resources â†’ Need: vpc_id, subnet_id(s), security_group_ids
â€¢ Compute resources â†’ May need: subnet_id, image_id/AMI, instance_type, key_pair, user_data
â€¢ Storage resources â†’ May need: volume_type, size, encryption, kms_key
â€¢ Database resources â†’ May need: db_subnet_group_name, engine, engine_version, master_user
â€¢ Container resources â†’ May need: cluster_name, task_definition, service_role, execution_role
â€¢ Serverless resources â†’ May need: role_arn, runtime, handler, code/package
â€¢ Load balanced resources â†’ May need: load_balancer_arn, target_group_arn, listener_arn
â€¢ Multi-AZ resources â†’ Need: Multiple subnet_ids in different AZs
â€¢ Encrypted resources â†’ May need: kms_key_id or encryption configuration
â€¢ Monitored resources â†’ May need: cloud_watch_log_group, alarm_actions

GENERAL RULE: Analyze Tool parameters to determine dependencies for ANY resource type

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“– COMPLETE EXAMPLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Scenario: Create subnets in managed VPC

MANAGED RESOURCES shows:
- vpc-04aea (vpc): created [vpc_id:vpc-04aea, cidr_block:10.0.0.0/16]

User Request: "Create two public subnets"

âœ… CORRECT PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "VPC vpc-04aea exists in MANAGED. Extract vpc_id and create subnets directly.",
  "confidence": 0.9,
  "executionPlan": [
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.1.0/24",
        "name": "public-subnet-1"
      },
      "dependsOn": []                 // No dependency
    },
    {
      "id": "step-create-subnet-2",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "vpc-04aea",         // From MANAGED
        "cidr_block": "10.0.2.0/24",
        "name": "public-subnet-2"
      },
      "dependsOn": []
    }
  ]
}

âŒ WRONG PLAN:
{
  "action": "create_infrastructure",
  "reasoning": "Need to discover VPC first",
  "confidence": 0.8,
  "executionPlan": [
    {
      "id": "step-discover-vpc",        // WRONG! VPC is MANAGED!
      "action": "query",  // Don't discover MANAGED resources!
      "mcpTool": "list-vpcs"
    },
    {
      "id": "step-create-subnet-1",
      "action": "create",
      "mcpTool": "create-public-subnet",
      "toolParameters": {
        "vpc_id": "{step-discover-vpc.vpc_id}"  // WRONG! Should use "vpc-04aea" directly
      },
      "dependsOn": ["step-discover-vpc"]        // Unnecessary dependency!
    }
  ]
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¤ JSON OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Return ONLY valid JSON (no markdown):

{
  "action": "create_infrastructure|update_infrastructure|delete_infrastructure|no_action",
  "reasoning": "Explain your analysis and which MANAGED resources you're reusing",
  "confidence": 0.0-1.0,
  "confidenceFactors": {
    "stateCompleteness": "Assessment of available information",
    "requirementClarity": "How well-defined the request is",
    "toolAvailability": "Availability of required tools",
    "complexityRating": "low|medium|high"
  },
  "resourcesAnalyzed": {
    "managedCount": 0,
    "discoveredCount": 0,
    "reusableResources": ["List MANAGED resources being reused"],
    "potentialConflicts": []
  },
  "executionPlan": [
    {
      "id": "unique-step-id",
      "name": "Human-readable name",
      "description": "What and why",
      "action": "create|query",
      "resourceId": "logical-identifier",
      "mcpTool": "exact-tool-name",
      "toolParameters": {
        "param_1": "literal-value",
        "param_2": "{step-id.field}"
      },
      "dependsOn": ["step-ids"],
      "estimatedDuration": "30s",
      "riskLevel": "low|medium|high",
      "status": "pending"
    }
  ],
  "recoveryStrategy": {
    "enableAutoRetry": true,
    "maxRetries": 3,
    "backoffStrategy": "exponential",
    "fallbackOptions": []
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… VALIDATION CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before submitting:

STATE AWARENESS (CRITICAL):
â–¡ Checked if "ğŸ—ï¸ MANAGED RESOURCES" section exists
â–¡ If section exists: verified each needed resource is NOT in MANAGED
â–¡ If resource in MANAGED: extracted [property:value] and used directly
â–¡ If section doesn't exist/empty: proceed with normal discovery/creation
â–¡ NO discovery steps for MANAGED resources
â–¡ NO dependsOn for MANAGED resource values

STRUCTURE:
â–¡ Only "create" or "query" actions
â–¡ All query steps FIRST
â–¡ Every {step-id.field} has step-id in dependsOn
â–¡ No forward references
â–¡ Parameters use snake_case
â–¡ Valid JSON only (no markdown)

EXAMPLES TO REMEMBER:
â–¡ VPC in MANAGED [vpc_id:vpc-xxx]? â†’ "vpc_id":"vpc-xxx" directly, NO discovery
â–¡ Subnet in MANAGED [subnet_id:subnet-xxx]? â†’ Use directly, NO discovery
â–¡ Security group in MANAGED [group_id:sg-xxx]? â†’ Use directly, NO discovery
â–¡ RDS in MANAGED [db_instance_identifier:xxx]? â†’ Use directly, NO discovery
â–¡ Lambda in MANAGED [function_arn:arn...]? â†’ Use directly, NO discovery
â–¡ S3 in MANAGED [bucket_name:xxx]? â†’ Use directly, NO discovery
â–¡ ANY resource in MANAGED? â†’ Extract [property:value] and use directly!

TOOL OUTPUT FIELD NAMES:
â€¢ get-latest-ubuntu-ami: "ami_id" (e.g., {step-discover-ami.ami_id})
â€¢ list-subnets: "subnets" (list of objects, each with "subnet_id") (e.g., {step-discover-subnets.subnets[0].subnet_id})
â€¢ list-security-groups: "security_groups" (list of objects, each with "group_id") (e.g., {step-discover-sg.security_groups[0].group_id})
â€¢ create-ec2-instance: Requires "key_name" (e.g., "my-key-{timestamp}")

BEGIN YOUR ANALYSIS AND PROVIDE YOUR JSON RESPONSE:
Sending prompt to LLM...
WebSocket connection accepted.
Plan execution started. Processing steps...
--- Preparing to execute step: 'Get latest Ubuntu AMI' (ID: step-get-ubuntu-ami) ---
Executing tool 'get-latest-ubuntu-ami' with resolved params: {'architecture': 'x86_64'}
Executing tool 'get-latest-ubuntu-ami' with params: {'architecture': 'x86_64'}
Getting latest Ubuntu AMI...
Searching for latest Ubuntu Server 22.04 LTS AMI...
Found latest Ubuntu AMI: ami-0850ab57897dcaa32
Tool 'get-latest-ubuntu-ami' executed successfully.
Step 'Get latest Ubuntu AMI' completed. Result stored in context for ID 'step-get-ubuntu-ami'.
--- Preparing to execute step: 'List Availability Zones' (ID: step-list-azs) ---
Executing tool 'list-availability-zones' with resolved params: {}
Executing tool 'list-availability-zones' with params: {}
Executing tool: list-availability-zones
Listing all Availability Zones.
Tool 'list-availability-zones' executed successfully.
Step 'List Availability Zones' completed. Result stored in context for ID 'step-list-azs'.
--- Preparing to execute step: 'Create new VPC' (ID: step-create-vpc) ---
Executing tool 'create-vpc' with resolved params: {'cidr_block': '10.0.0.0/16', 'name': 'web-vpc-20251103194333'}
Executing tool 'create-vpc' with params: {'cidr_block': '10.0.0.0/16', 'name': 'web-vpc-20251103194333'}
Executing CreateVpcTool with CIDR: 10.0.0.0/16
Creating VPC with CIDR block: 10.0.0.0/16
VPC created: vpc-0647b1a47a895fad8
Tool 'create-vpc' executed successfully.
Step 'Create new VPC' completed. Result stored in context for ID 'step-create-vpc'.
--- Preparing to execute step: 'Create Internet Gateway' (ID: step-create-igw) ---
Executing tool 'create-internet-gateway' with resolved params: {'name': 'web-igw-20251103194335'}
Executing tool 'create-internet-gateway' with params: {'name': 'web-igw-20251103194335'}
Executing tool: create-internet-gateway
Creating Internet Gateway.
Internet Gateway created: igw-09ee2c516207c7315
Tool 'create-internet-gateway' executed successfully.
Step 'Create Internet Gateway' completed. Result stored in context for ID 'step-create-igw'.
--- Preparing to execute step: 'Attach Internet Gateway to VPC' (ID: step-attach-igw) ---
Executing tool 'attach-internet-gateway' with resolved params: {'vpc_id': 'vpc-0647b1a47a895fad8', 'internet_gateway_id': 'igw-09ee2c516207c7315'}
Executing tool 'attach-internet-gateway' with params: {'vpc_id': 'vpc-0647b1a47a895fad8', 'internet_gateway_id': 'igw-09ee2c516207c7315'}
Executing tool: attach-internet-gateway
Attaching Internet Gateway 'igw-09ee2c516207c7315' to VPC 'vpc-0647b1a47a895fad8'.
Internet Gateway 'igw-09ee2c516207c7315' successfully attached to VPC 'vpc-0647b1a47a895fad8'.
Tool 'attach-internet-gateway' executed successfully.
Step 'Attach Internet Gateway to VPC' completed. Result stored in context for ID 'step-attach-igw'.
--- Preparing to execute step: 'Create Public Subnet' (ID: step-create-public-subnet) ---
Executing tool 'create-public-subnet' with resolved params: {'vpc_id': 'vpc-0647b1a47a895fad8', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-public-subnet-20251103194335'}
Executing tool 'create-public-subnet' with params: {'vpc_id': 'vpc-0647b1a47a895fad8', 'cidr_block': '10.0.1.0/24', 'availability_zone': 'eu-west-2a', 'name': 'web-public-subnet-20251103194335'}
Executing tool: create-public-subnet
Creating subnet with CIDR block '10.0.1.0/24' in VPC 'vpc-0647b1a47a895fad8' (AZ: eu-west-2a).
Subnet created: subnet-041306c8a5d738899
Modifying subnet 'subnet-041306c8a5d738899' to set map_public_ip_on_launch to True.
Subnet 'subnet-041306c8a5d738899' attribute modified successfully.
Tool 'create-public-subnet' executed successfully.
Step 'Create Public Subnet' completed. Result stored in context for ID 'step-create-public-subnet'.
--- Preparing to execute step: 'Create EC2 Key Pair 'test-key-04'' (ID: step-create-key-pair) ---
Executing tool 'create-key-pair' with resolved params: {'key_name': 'test-key-04'}
Executing tool 'create-key-pair' with params: {'key_name': 'test-key-04'}
Executing CreateKeyPairTool with key_name: test-key-04
Creating key pair: test-key-04
Tool 'create-key-pair' executed successfully.
Step 'Create EC2 Key Pair 'test-key-04'' completed. Result stored in context for ID 'step-create-key-pair'.
--- Preparing to execute step: 'Create Security Group 'web-sg'' (ID: step-create-security-group) ---
Executing tool 'create-security-group' with resolved params: {'group_name': 'web-sg', 'description': 'Allow SSH and HTTP access for web server', 'vpc_id': 'vpc-0647b1a47a895fad8'}
Executing tool 'create-security-group' with params: {'group_name': 'web-sg', 'description': 'Allow SSH and HTTP access for web server', 'vpc_id': 'vpc-0647b1a47a895fad8'}
Creating security group 'web-sg' in VPC 'vpc-0647b1a47a895fad8'...
Security group 'web-sg' created with ID: sg-07112a519dc63adef
Security group 'web-sg' created with ID: sg-07112a519dc63adef
Tool 'create-security-group' executed successfully.
Step 'Create Security Group 'web-sg'' completed. Result stored in context for ID 'step-create-security-group'.
--- Preparing to execute step: 'Add SSH Ingress Rule' (ID: step-add-ssh-ingress) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-07112a519dc63adef', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-07112a519dc63adef', 'protocol': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-07112a519dc63adef' for tcp:22-22 from 0.0.0.0/0...
Ingress rule added to security group 'sg-07112a519dc63adef'.
Ingress rule added to security group 'sg-07112a519dc63adef'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add SSH Ingress Rule' completed. Result stored in context for ID 'step-add-ssh-ingress'.
--- Preparing to execute step: 'Add HTTP Ingress Rule' (ID: step-add-http-ingress) ---
Executing tool 'add-security-group-ingress-rule' with resolved params: {'group_id': 'sg-07112a519dc63adef', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Executing tool 'add-security-group-ingress-rule' with params: {'group_id': 'sg-07112a519dc63adef', 'protocol': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_block': '0.0.0.0/0'}
Adding ingress rule to security group 'sg-07112a519dc63adef' for tcp:80-80 from 0.0.0.0/0...
Ingress rule added to security group 'sg-07112a519dc63adef'.
Ingress rule added to security group 'sg-07112a519dc63adef'.
Tool 'add-security-group-ingress-rule' executed successfully.
Step 'Add HTTP Ingress Rule' completed. Result stored in context for ID 'step-add-http-ingress'.
--- Preparing to execute step: 'Create EC2 Instance' (ID: step-create-ec2-instance) ---
Executing tool 'create-ec2-instance' with resolved params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-04', 'subnet_id': 'subnet-041306c8a5d738899', 'security_group_ids': ['sg-07112a519dc63adef'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103194341'}]}
Executing tool 'create-ec2-instance' with params: {'image_id': 'ami-0850ab57897dcaa32', 'instance_type': 't3.micro', 'key_name': 'test-key-04', 'subnet_id': 'subnet-041306c8a5d738899', 'security_group_ids': ['sg-07112a519dc63adef'], 'tags': [{'Key': 'Name', 'Value': 'web-server-20251103194341'}]}
Executing tool: create-ec2-instance
Creating EC2 instance with image 'ami-0850ab57897dcaa32' and type 't3.micro'
Tool 'create-ec2-instance' executed successfully.
Step 'Create EC2 Instance' completed. Result stored in context for ID 'step-create-ec2-instance'.
Added/updated resource 'i-0bb6f7fde5a42ee14' to the state.
Saved new resource 'i-0bb6f7fde5a42ee14' of type 'aws_ec2_instance' to state.
--- Preparing to execute step: 'Create S3 Bucket for Logs' (ID: step-create-s3-bucket) ---
Executing tool 'create-s3-bucket' with resolved params: {'bucket_name': 'web-logs-20251103194342', 'region': 'eu-west-2'}
Executing tool 'create-s3-bucket' with params: {'bucket_name': 'web-logs-20251103194342', 'region': 'eu-west-2'}
Executing CreateS3BucketTool for bucket: web-logs-20251103194342
Attempting to create S3 bucket: web-logs-20251103194342
Using effective region for S3 bucket creation: eu-west-2
Creating S3 bucket: web-logs-20251103194342 in region: eu-west-2
S3 bucket 'web-logs-20251103194342' created successfully.
Tool 'create-s3-bucket' executed successfully.
Step 'Create S3 Bucket for Logs' completed. Result stored in context for ID 'step-create-s3-bucket'.
>>>>>>> 3d3a2cbccf1753872a42818ae52d778a78a26cf8
Plan execution finished successfully.
WebSocket connection closed.
